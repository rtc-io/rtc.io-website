!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.glue=e():"undefined"!=typeof global?global.glue=e():"undefined"!=typeof self&&(self.glue=e())}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var toString=Object.prototype.toString;var hasOwnProperty=Object.prototype.hasOwnProperty;function isArray(xs){return toString.call(xs)==="[object Array]"}exports.isArray=typeof Array.isArray==="function"?Array.isArray:isArray;exports.indexOf=function indexOf(xs,x){if(xs.indexOf)return xs.indexOf(x);for(var i=0;i<xs.length;i++){if(x===xs[i])return i}return-1};exports.filter=function filter(xs,fn){if(xs.filter)return xs.filter(fn);var res=[];for(var i=0;i<xs.length;i++){if(fn(xs[i],i,xs))res.push(xs[i])}return res};exports.forEach=function forEach(xs,fn,self){if(xs.forEach)return xs.forEach(fn,self);for(var i=0;i<xs.length;i++){fn.call(self,xs[i],i,xs)}};exports.map=function map(xs,fn){if(xs.map)return xs.map(fn);var out=new Array(xs.length);for(var i=0;i<xs.length;i++){out[i]=fn(xs[i],i,xs)}return out};exports.reduce=function reduce(array,callback,opt_initialValue){if(array.reduce)return array.reduce(callback,opt_initialValue);var value,isValueSet=false;if(2<arguments.length){value=opt_initialValue;isValueSet=true}for(var i=0,l=array.length;l>i;++i){if(array.hasOwnProperty(i)){if(isValueSet){value=callback(value,array[i],i,array)}else{value=array[i];isValueSet=true}}}return value};if("ab".substr(-1)!=="b"){exports.substr=function(str,start,length){if(start<0)start=str.length+start;return str.substr(start,length)}}else{exports.substr=function(str,start,length){return str.substr(start,length)}}exports.trim=function(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")};exports.bind=function(){var args=Array.prototype.slice.call(arguments);var fn=args.shift();if(fn.bind)return fn.bind.apply(fn,args);var self=args.shift();return function(){fn.apply(self,args.concat([Array.prototype.slice.call(arguments)]))}};function create(prototype,properties){var object;if(prototype===null){object={__proto__:null}}else{if(typeof prototype!=="object"){throw new TypeError("typeof prototype["+typeof prototype+"] != 'object'")}var Type=function(){};Type.prototype=prototype;object=new Type;object.__proto__=prototype}if(typeof properties!=="undefined"&&Object.defineProperties){Object.defineProperties(object,properties)}return object}exports.create=typeof Object.create==="function"?Object.create:create;function notObject(object){return typeof object!="object"&&typeof object!="function"||object===null}function keysShim(object){if(notObject(object)){throw new TypeError("Object.keys called on a non-object")}var result=[];for(var name in object){if(hasOwnProperty.call(object,name)){result.push(name)}}return result}function propertyShim(object){if(notObject(object)){throw new TypeError("Object.getOwnPropertyNames called on a non-object")}var result=keysShim(object);if(exports.isArray(object)&&exports.indexOf(object,"length")===-1){result.push("length")}return result}var keys=typeof Object.keys==="function"?Object.keys:keysShim;var getOwnPropertyNames=typeof Object.getOwnPropertyNames==="function"?Object.getOwnPropertyNames:propertyShim;if((new Error).hasOwnProperty("description")){var ERROR_PROPERTY_FILTER=function(obj,array){if(toString.call(obj)==="[object Error]"){array=exports.filter(array,function(name){return name!=="description"&&name!=="number"&&name!=="message"})}return array};exports.keys=function(object){return ERROR_PROPERTY_FILTER(object,keys(object))};exports.getOwnPropertyNames=function(object){return ERROR_PROPERTY_FILTER(object,getOwnPropertyNames(object))}}else{exports.keys=keys;exports.getOwnPropertyNames=getOwnPropertyNames}function valueObject(value,key){return{value:value[key]}}if(typeof Object.getOwnPropertyDescriptor==="function"){try{Object.getOwnPropertyDescriptor({a:1},"a");exports.getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor}catch(e){exports.getOwnPropertyDescriptor=function(value,key){try{return Object.getOwnPropertyDescriptor(value,key)}catch(e){return valueObject(value,key)}}}}else{exports.getOwnPropertyDescriptor=valueObject}},{}],2:[function(require,module,exports){var util=require("util");var shims=require("_shims");var pSlice=Array.prototype.slice;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;this.message=options.message||getMessage(this)};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&(isNaN(value)||!isFinite(value))){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}try{var ka=shims.keys(a),kb=shims.keys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}}},{_shims:1,util:6}],3:[function(require,module,exports){var util=require("util");function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||n<0)throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||util.isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{throw TypeError('Uncaught, unspecified "error" event.')}return false}}handler=this._events[type];if(util.isUndefined(handler))return false;if(util.isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(util.isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(util.isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(util.isObject(this._events[type])&&!this._events[type].warned){var m;if(!util.isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);console.trace()}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!util.isFunction(listener))throw TypeError("listener must be a function");function g(){this.removeListener(type,g);listener.apply(this,arguments)}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||util.isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(util.isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(util.isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(util.isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(util.isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret}},{util:6}],4:[function(require,module,exports){var QueryString=exports;var util=require("util");var shims=require("_shims");var Buffer=require("buffer").Buffer;function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}function charCode(c){return c.charCodeAt(0)}QueryString.unescapeBuffer=function(s,decodeSpaces){var out=new Buffer(s.length);var state="CHAR";var n,m,hexchar;for(var inIndex=0,outIndex=0;inIndex<=s.length;inIndex++){var c=s.charCodeAt(inIndex);switch(state){case"CHAR":switch(c){case charCode("%"):n=0;m=0;state="HEX0";break;case charCode("+"):if(decodeSpaces)c=charCode(" ");default:out[outIndex++]=c;break}break;case"HEX0":state="HEX1";hexchar=c;if(charCode("0")<=c&&c<=charCode("9")){n=c-charCode("0")}else if(charCode("a")<=c&&c<=charCode("f")){n=c-charCode("a")+10}else if(charCode("A")<=c&&c<=charCode("F")){n=c-charCode("A")+10}else{out[outIndex++]=charCode("%");out[outIndex++]=c;state="CHAR";break}break;case"HEX1":state="CHAR";if(charCode("0")<=c&&c<=charCode("9")){m=c-charCode("0")}else if(charCode("a")<=c&&c<=charCode("f")){m=c-charCode("a")+10}else if(charCode("A")<=c&&c<=charCode("F")){m=c-charCode("A")+10}else{out[outIndex++]=charCode("%");out[outIndex++]=hexchar;out[outIndex++]=c;break}out[outIndex++]=16*n+m;break}}return out.slice(0,outIndex-1)};QueryString.unescape=function(s,decodeSpaces){return QueryString.unescapeBuffer(s,decodeSpaces).toString()};QueryString.escape=function(str){return encodeURIComponent(str)};var stringifyPrimitive=function(v){if(util.isString(v))return v;if(util.isBoolean(v))return v?"true":"false";if(util.isNumber(v))return isFinite(v)?v:"";return""};QueryString.stringify=QueryString.encode=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(util.isNull(obj)){obj=undefined}if(util.isObject(obj)){return shims.map(shims.keys(obj),function(k){var ks=QueryString.escape(stringifyPrimitive(k))+eq;if(util.isArray(obj[k])){return shims.map(obj[k],function(v){return ks+QueryString.escape(stringifyPrimitive(v))}).join(sep)}else{return ks+QueryString.escape(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return QueryString.escape(stringifyPrimitive(name))+eq+QueryString.escape(stringifyPrimitive(obj))};QueryString.parse=QueryString.decode=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(!util.isString(qs)||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&util.isNumber(options.maxKeys)){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}try{k=decodeURIComponent(kstr);v=decodeURIComponent(vstr)}catch(e){k=QueryString.unescape(kstr,true);v=QueryString.unescape(vstr,true)}if(!hasOwnProperty(obj,k)){obj[k]=v}else if(util.isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj}},{_shims:1,buffer:8,util:6}],5:[function(require,module,exports){var punycode={encode:function(s){return s}};var util=require("util");var shims=require("_shims");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var rest=url;rest=shims.trim(rest);var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){var domainArray=this.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}this.hostname=newOut.join(".")}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&util.isObject(this.query)&&shims.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&shims.substr(protocol,-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;shims.forEach(shims.keys(this),function(k){result[k]=this[k]},this);result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){shims.forEach(shims.keys(relative),function(k){if(k!=="protocol")result[k]=relative[k]});if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){shims.forEach(shims.keys(relative),function(k){result[k]=relative[k]});result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&shims.substr(srcPath.join("/"),-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host}},{_shims:1,querystring:4,util:6}],6:[function(require,module,exports){var shims=require("_shims");var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};shims.forEach(array,function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=shims.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=shims.getOwnPropertyNames(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];
for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}shims.forEach(keys,function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=shims.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(shims.indexOf(ctx.seen,desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=shims.reduce(output,function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return shims.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&objectToString(e)==="[object Error]"}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.binarySlice==="function"}exports.isBuffer=isBuffer;function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=function(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=shims.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})};exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=shims.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}},{_shims:1}],7:[function(require,module,exports){exports.readIEEE754=function(buffer,offset,isBE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isBE?0:nBytes-1,d=isBE?1:-1,s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8);m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.writeIEEE754=function(buffer,value,offset,isBE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0,i=isBE?nBytes-1:0,d=isBE?-1:1,s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8);e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=s*128}},{}],8:[function(require,module,exports){var assert;exports.Buffer=Buffer;exports.SlowBuffer=Buffer;Buffer.poolSize=8192;exports.INSPECT_MAX_BYTES=50;function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function Buffer(subject,encoding,offset){if(!assert)assert=require("assert");if(!(this instanceof Buffer)){return new Buffer(subject,encoding,offset)}this.parent=this;this.offset=0;if(encoding=="base64"&&typeof subject=="string"){subject=stringtrim(subject);while(subject.length%4!=0){subject=subject+"="}}var type;if(typeof offset==="number"){this.length=coerce(encoding);for(var i=0;i<this.length;i++){this[i]=subject.get(i+offset)}}else{switch(type=typeof subject){case"number":this.length=coerce(subject);break;case"string":this.length=Buffer.byteLength(subject,encoding);break;case"object":this.length=coerce(subject.length);break;default:throw new Error("First argument needs to be a number, "+"array or string.")}if(isArrayIsh(subject)){for(var i=0;i<this.length;i++){if(subject instanceof Buffer){this[i]=subject.readUInt8(i)}else{this[i]=subject[i]}}}else if(type=="string"){this.length=this.write(subject,0,encoding)}else if(type==="number"){for(var i=0;i<this.length;i++){this[i]=0}}}}Buffer.prototype.get=function get(i){if(i<0||i>=this.length)throw new Error("oob");return this[i]};Buffer.prototype.set=function set(i,v){if(i<0||i>=this.length)throw new Error("oob");return this[i]=v};Buffer.byteLength=function(str,encoding){switch(encoding||"utf8"){case"hex":return str.length/2;case"utf8":case"utf-8":return utf8ToBytes(str).length;case"ascii":case"binary":return str.length;case"base64":return base64ToBytes(str).length;default:throw new Error("Unknown encoding")}};Buffer.prototype.utf8Write=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(utf8ToBytes(string),this,offset,length)};Buffer.prototype.asciiWrite=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(asciiToBytes(string),this,offset,length)};Buffer.prototype.binaryWrite=Buffer.prototype.asciiWrite;Buffer.prototype.base64Write=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(base64ToBytes(string),this,offset,length)};Buffer.prototype.base64Slice=function(start,end){var bytes=Array.prototype.slice.apply(this,arguments);return require("base64-js").fromByteArray(bytes)};Buffer.prototype.utf8Slice=function(){var bytes=Array.prototype.slice.apply(this,arguments);var res="";var tmp="";var i=0;while(i<bytes.length){if(bytes[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(bytes[i]);tmp=""}else tmp+="%"+bytes[i].toString(16);i++}return res+decodeUtf8Char(tmp)};Buffer.prototype.asciiSlice=function(){var bytes=Array.prototype.slice.apply(this,arguments);var ret="";for(var i=0;i<bytes.length;i++)ret+=String.fromCharCode(bytes[i]);return ret};Buffer.prototype.binarySlice=Buffer.prototype.asciiSlice;Buffer.prototype.inspect=function(){var out=[],len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i==exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};Buffer.prototype.hexSlice=function(start,end){var len=this.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(this[i])}return out};Buffer.prototype.toString=function(encoding,start,end){encoding=String(encoding||"utf8").toLowerCase();start=+start||0;if(typeof end=="undefined")end=this.length;if(+end==start){return""}switch(encoding){case"hex":return this.hexSlice(start,end);case"utf8":case"utf-8":return this.utf8Slice(start,end);case"ascii":return this.asciiSlice(start,end);case"binary":return this.binarySlice(start,end);case"base64":return this.base64Slice(start,end);case"ucs2":case"ucs-2":return this.ucs2Slice(start,end);default:throw new Error("Unknown encoding")}};Buffer.prototype.hexWrite=function(string,offset,length){offset=+offset||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=+length;if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2){throw new Error("Invalid hex string")}if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);if(isNaN(byte))throw new Error("Invalid hex string");this[offset+i]=byte}Buffer._charsWritten=i*2;return i};Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=+offset||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=+length;if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();switch(encoding){case"hex":return this.hexWrite(string,offset,length);case"utf8":case"utf-8":return this.utf8Write(string,offset,length);case"ascii":return this.asciiWrite(string,offset,length);case"binary":return this.binaryWrite(string,offset,length);case"base64":return this.base64Write(string,offset,length);case"ucs2":case"ucs-2":return this.ucs2Write(string,offset,length);default:throw new Error("Unknown encoding")}};function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);return new Buffer(this,end-start,+start)};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;start||(start=0);if(end===undefined||isNaN(end)){end=this.length}target_start||(target_start=0);if(end<start)throw new Error("sourceEnd < sourceStart");if(end===start)return 0;if(target.length==0||source.length==0)return 0;if(target_start<0||target_start>=target.length){throw new Error("targetStart out of bounds")}if(start<0||start>=source.length){throw new Error("sourceStart out of bounds")}if(end<0||end>source.length){throw new Error("sourceEnd out of bounds")}if(end>this.length){end=this.length}if(target.length-target_start<end-start){end=target.length-target_start+start}var temp=[];for(var i=start;i<end;i++){assert.ok(typeof this[i]!=="undefined","copying undefined buffer bytes!");temp.push(this[i])}for(var i=target_start;i<target_start+temp.length;i++){target[i]=temp[i-target_start]}};Buffer.prototype.fill=function fill(value,start,end){value||(value=0);start||(start=0);end||(end=this.length);if(typeof value==="string"){value=value.charCodeAt(0)}if(!(typeof value==="number")||isNaN(value)){throw new Error("value is not a number")}if(end<start)throw new Error("end < start");if(end===start)return 0;if(this.length==0)return 0;if(start<0||start>=this.length){throw new Error("start out of bounds")}if(end<0||end>this.length){throw new Error("end out of bounds")}for(var i=start;i<end;i++){this[i]=value}};Buffer.isBuffer=function isBuffer(b){return b instanceof Buffer||b instanceof Buffer};Buffer.concat=function(list,totalLength){if(!isArray(list)){throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.")}if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}if(typeof totalLength!=="number"){totalLength=0;for(var i=0;i<list.length;i++){var buf=list[i];totalLength+=buf.length}}var buffer=new Buffer(totalLength);var pos=0;for(var i=0;i<list.length;i++){var buf=list[i];buf.copy(buffer,pos);pos+=buf.length}return buffer};Buffer.isEncoding=function(encoding){switch((encoding+"").toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return true;default:return false}};function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return{}.toString.apply(subject)=="[object Array]"})(subject)}function isArrayIsh(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)if(str.charCodeAt(i)<=127)byteArray.push(str.charCodeAt(i));else{var h=encodeURIComponent(str.charAt(i)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)byteArray.push(str.charCodeAt(i)&255);return byteArray}function base64ToBytes(str){return require("base64-js").toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos,i=0;while(i<length){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i];i++}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}Buffer.prototype.readUInt8=function(offset,noAssert){var buffer=this;if(!noAssert){assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return;return buffer[offset]};function readUInt16(buffer,offset,isBigEndian,noAssert){var val=0;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return 0;if(isBigEndian){val=buffer[offset]<<8;if(offset+1<buffer.length){val|=buffer[offset+1]}}else{val=buffer[offset];if(offset+1<buffer.length){val|=buffer[offset+1]<<8}}return val}Buffer.prototype.readUInt16LE=function(offset,noAssert){return readUInt16(this,offset,false,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return readUInt16(this,offset,true,noAssert)};function readUInt32(buffer,offset,isBigEndian,noAssert){var val=0;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return 0;if(isBigEndian){if(offset+1<buffer.length)val=buffer[offset+1]<<16;if(offset+2<buffer.length)val|=buffer[offset+2]<<8;if(offset+3<buffer.length)val|=buffer[offset+3];val=val+(buffer[offset]<<24>>>0)}else{if(offset+2<buffer.length)val=buffer[offset+2]<<16;if(offset+1<buffer.length)val|=buffer[offset+1]<<8;val|=buffer[offset];if(offset+3<buffer.length)val=val+(buffer[offset+3]<<24>>>0)}return val}Buffer.prototype.readUInt32LE=function(offset,noAssert){return readUInt32(this,offset,false,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return readUInt32(this,offset,true,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){var buffer=this;var neg;if(!noAssert){assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return;neg=buffer[offset]&128;if(!neg){return buffer[offset]}return(255-buffer[offset]+1)*-1};function readInt16(buffer,offset,isBigEndian,noAssert){var neg,val;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to read beyond buffer length")}val=readUInt16(buffer,offset,isBigEndian,noAssert);neg=val&32768;if(!neg){return val}return(65535-val+1)*-1}Buffer.prototype.readInt16LE=function(offset,noAssert){return readInt16(this,offset,false,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return readInt16(this,offset,true,noAssert)};function readInt32(buffer,offset,isBigEndian,noAssert){var neg,val;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}val=readUInt32(buffer,offset,isBigEndian,noAssert);neg=val&2147483648;if(!neg){return val}return(4294967295-val+1)*-1}Buffer.prototype.readInt32LE=function(offset,noAssert){return readInt32(this,offset,false,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return readInt32(this,offset,true,noAssert)};function readFloat(buffer,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}return require("./buffer_ieee754").readIEEE754(buffer,offset,isBigEndian,23,4)}Buffer.prototype.readFloatLE=function(offset,noAssert){return readFloat(this,offset,false,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return readFloat(this,offset,true,noAssert)};function readDouble(buffer,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset+7<buffer.length,"Trying to read beyond buffer length")}return require("./buffer_ieee754").readIEEE754(buffer,offset,isBigEndian,52,8)}Buffer.prototype.readDoubleLE=function(offset,noAssert){return readDouble(this,offset,false,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return readDouble(this,offset,true,noAssert)};function verifuint(value,max){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value>=0,"specified a negative value for writing an unsigned value");assert.ok(value<=max,"value is larger than maximum value for type");assert.ok(Math.floor(value)===value,"value has a fractional component")}Buffer.prototype.writeUInt8=function(value,offset,noAssert){var buffer=this;if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"trying to write beyond buffer length");verifuint(value,255)}if(offset<buffer.length){buffer[offset]=value}};function writeUInt16(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"trying to write beyond buffer length");verifuint(value,65535)}for(var i=0;i<Math.min(buffer.length-offset,2);i++){buffer[offset+i]=(value&255<<8*(isBigEndian?1-i:i))>>>(isBigEndian?1-i:i)*8}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){writeUInt16(this,value,offset,false,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){writeUInt16(this,value,offset,true,noAssert)};function writeUInt32(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"trying to write beyond buffer length");verifuint(value,4294967295)}for(var i=0;i<Math.min(buffer.length-offset,4);i++){buffer[offset+i]=value>>>(isBigEndian?3-i:i)*8&255}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){writeUInt32(this,value,offset,true,noAssert)};function verifsint(value,max,min){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value<=max,"value larger than maximum allowed value");assert.ok(value>=min,"value smaller than minimum allowed value");assert.ok(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value<=max,"value larger than maximum allowed value");assert.ok(value>=min,"value smaller than minimum allowed value")}Buffer.prototype.writeInt8=function(value,offset,noAssert){var buffer=this;if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(value>=0){buffer.writeUInt8(value,offset,noAssert)}else{buffer.writeUInt8(255+value+1,offset,noAssert)}};function writeInt16(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}if(value>=0){writeUInt16(buffer,value,offset,isBigEndian,noAssert)}else{writeUInt16(buffer,65535+value+1,offset,isBigEndian,noAssert)}}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){writeInt16(this,value,offset,false,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){writeInt16(this,value,offset,true,noAssert)};function writeInt32(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}if(value>=0){writeUInt32(buffer,value,offset,isBigEndian,noAssert)}else{writeUInt32(buffer,4294967295+value+1,offset,isBigEndian,noAssert)}}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){writeInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){writeInt32(this,value,offset,true,noAssert)};function writeFloat(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}require("./buffer_ieee754").writeIEEE754(buffer,value,offset,isBigEndian,23,4)}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){writeFloat(this,value,offset,false,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){writeFloat(this,value,offset,true,noAssert)};function writeDouble(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+7<buffer.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}require("./buffer_ieee754").writeIEEE754(buffer,value,offset,isBigEndian,52,8)}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){writeDouble(this,value,offset,true,noAssert)}},{"./buffer_ieee754":7,assert:2,"base64-js":9}],9:[function(require,module,exports){(function(exports){"use strict";var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw"Invalid string. Length must be a multiple of 4"}placeHolders=b64.indexOf("=");placeHolders=placeHolders>0?b64.length-placeHolders:0;arr=[];l=placeHolders>0?b64.length-4:b64.length;for(i=0,j=0;i<l;i+=4,j+=3){tmp=lookup.indexOf(b64[i])<<18|lookup.indexOf(b64[i+1])<<12|lookup.indexOf(b64[i+2])<<6|lookup.indexOf(b64[i+3]);arr.push((tmp&16711680)>>16);arr.push((tmp&65280)>>8);arr.push(tmp&255)}if(placeHolders===2){tmp=lookup.indexOf(b64[i])<<2|lookup.indexOf(b64[i+1])>>4;arr.push(tmp&255)}else if(placeHolders===1){tmp=lookup.indexOf(b64[i])<<10|lookup.indexOf(b64[i+1])<<4|lookup.indexOf(b64[i+2])>>2;arr.push(tmp>>8&255);arr.push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=lookup[temp>>2];output+=lookup[temp<<4&63];output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=lookup[temp>>10];output+=lookup[temp>>4&63];output+=lookup[temp<<2&63];output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],10:[function(require,module,exports){require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){exports.readIEEE754=function(buffer,offset,isBE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isBE?0:nBytes-1,d=isBE?1:-1,s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8);m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.writeIEEE754=function(buffer,value,offset,isBE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0,i=isBE?nBytes-1:0,d=isBE?-1:1,s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8);e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=s*128}},{}],q9TxCC:[function(require,module,exports){var assert;exports.Buffer=Buffer;exports.SlowBuffer=Buffer;Buffer.poolSize=8192;exports.INSPECT_MAX_BYTES=50;function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function Buffer(subject,encoding,offset){if(!assert)assert=require("assert");if(!(this instanceof Buffer)){return new Buffer(subject,encoding,offset)}this.parent=this;this.offset=0;if(encoding=="base64"&&typeof subject=="string"){subject=stringtrim(subject);while(subject.length%4!=0){subject=subject+"="}}var type;if(typeof offset==="number"){this.length=coerce(encoding);for(var i=0;i<this.length;i++){this[i]=subject.get(i+offset)}}else{switch(type=typeof subject){case"number":this.length=coerce(subject);break;case"string":this.length=Buffer.byteLength(subject,encoding);break;case"object":this.length=coerce(subject.length);break;default:throw new Error("First argument needs to be a number, "+"array or string.")}if(isArrayIsh(subject)){for(var i=0;i<this.length;i++){if(subject instanceof Buffer){this[i]=subject.readUInt8(i)}else{this[i]=subject[i]}}}else if(type=="string"){this.length=this.write(subject,0,encoding)}else if(type==="number"){for(var i=0;i<this.length;i++){this[i]=0}}}}Buffer.prototype.get=function get(i){if(i<0||i>=this.length)throw new Error("oob");return this[i]};Buffer.prototype.set=function set(i,v){if(i<0||i>=this.length)throw new Error("oob");return this[i]=v};Buffer.byteLength=function(str,encoding){switch(encoding||"utf8"){case"hex":return str.length/2;case"utf8":case"utf-8":return utf8ToBytes(str).length;case"ascii":case"binary":return str.length;case"base64":return base64ToBytes(str).length;default:throw new Error("Unknown encoding")}};Buffer.prototype.utf8Write=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(utf8ToBytes(string),this,offset,length)};Buffer.prototype.asciiWrite=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(asciiToBytes(string),this,offset,length)};Buffer.prototype.binaryWrite=Buffer.prototype.asciiWrite;Buffer.prototype.base64Write=function(string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(base64ToBytes(string),this,offset,length)};Buffer.prototype.base64Slice=function(start,end){var bytes=Array.prototype.slice.apply(this,arguments);return require("base64-js").fromByteArray(bytes)};Buffer.prototype.utf8Slice=function(){var bytes=Array.prototype.slice.apply(this,arguments);var res="";var tmp="";var i=0;while(i<bytes.length){if(bytes[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(bytes[i]);tmp=""}else tmp+="%"+bytes[i].toString(16);i++}return res+decodeUtf8Char(tmp)};Buffer.prototype.asciiSlice=function(){var bytes=Array.prototype.slice.apply(this,arguments);var ret="";for(var i=0;i<bytes.length;i++)ret+=String.fromCharCode(bytes[i]);return ret};Buffer.prototype.binarySlice=Buffer.prototype.asciiSlice;Buffer.prototype.inspect=function(){var out=[],len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i==exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};Buffer.prototype.hexSlice=function(start,end){var len=this.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(this[i])}return out};Buffer.prototype.toString=function(encoding,start,end){encoding=String(encoding||"utf8").toLowerCase();start=+start||0;if(typeof end=="undefined")end=this.length;if(+end==start){return""}switch(encoding){case"hex":return this.hexSlice(start,end);case"utf8":case"utf-8":return this.utf8Slice(start,end);case"ascii":return this.asciiSlice(start,end);case"binary":return this.binarySlice(start,end);
case"base64":return this.base64Slice(start,end);case"ucs2":case"ucs-2":return this.ucs2Slice(start,end);default:throw new Error("Unknown encoding")}};Buffer.prototype.hexWrite=function(string,offset,length){offset=+offset||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=+length;if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2){throw new Error("Invalid hex string")}if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);if(isNaN(byte))throw new Error("Invalid hex string");this[offset+i]=byte}Buffer._charsWritten=i*2;return i};Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=+offset||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=+length;if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();switch(encoding){case"hex":return this.hexWrite(string,offset,length);case"utf8":case"utf-8":return this.utf8Write(string,offset,length);case"ascii":return this.asciiWrite(string,offset,length);case"binary":return this.binaryWrite(string,offset,length);case"base64":return this.base64Write(string,offset,length);case"ucs2":case"ucs-2":return this.ucs2Write(string,offset,length);default:throw new Error("Unknown encoding")}};function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);return new Buffer(this,end-start,+start)};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;start||(start=0);if(end===undefined||isNaN(end)){end=this.length}target_start||(target_start=0);if(end<start)throw new Error("sourceEnd < sourceStart");if(end===start)return 0;if(target.length==0||source.length==0)return 0;if(target_start<0||target_start>=target.length){throw new Error("targetStart out of bounds")}if(start<0||start>=source.length){throw new Error("sourceStart out of bounds")}if(end<0||end>source.length){throw new Error("sourceEnd out of bounds")}if(end>this.length){end=this.length}if(target.length-target_start<end-start){end=target.length-target_start+start}var temp=[];for(var i=start;i<end;i++){assert.ok(typeof this[i]!=="undefined","copying undefined buffer bytes!");temp.push(this[i])}for(var i=target_start;i<target_start+temp.length;i++){target[i]=temp[i-target_start]}};Buffer.prototype.fill=function fill(value,start,end){value||(value=0);start||(start=0);end||(end=this.length);if(typeof value==="string"){value=value.charCodeAt(0)}if(!(typeof value==="number")||isNaN(value)){throw new Error("value is not a number")}if(end<start)throw new Error("end < start");if(end===start)return 0;if(this.length==0)return 0;if(start<0||start>=this.length){throw new Error("start out of bounds")}if(end<0||end>this.length){throw new Error("end out of bounds")}for(var i=start;i<end;i++){this[i]=value}};Buffer.isBuffer=function isBuffer(b){return b instanceof Buffer||b instanceof Buffer};Buffer.concat=function(list,totalLength){if(!isArray(list)){throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.")}if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}if(typeof totalLength!=="number"){totalLength=0;for(var i=0;i<list.length;i++){var buf=list[i];totalLength+=buf.length}}var buffer=new Buffer(totalLength);var pos=0;for(var i=0;i<list.length;i++){var buf=list[i];buf.copy(buffer,pos);pos+=buf.length}return buffer};Buffer.isEncoding=function(encoding){switch((encoding+"").toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return true;default:return false}};function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return{}.toString.apply(subject)=="[object Array]"})(subject)}function isArrayIsh(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)if(str.charCodeAt(i)<=127)byteArray.push(str.charCodeAt(i));else{var h=encodeURIComponent(str.charAt(i)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)byteArray.push(str.charCodeAt(i)&255);return byteArray}function base64ToBytes(str){return require("base64-js").toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos,i=0;while(i<length){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i];i++}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}Buffer.prototype.readUInt8=function(offset,noAssert){var buffer=this;if(!noAssert){assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return;return buffer[offset]};function readUInt16(buffer,offset,isBigEndian,noAssert){var val=0;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return 0;if(isBigEndian){val=buffer[offset]<<8;if(offset+1<buffer.length){val|=buffer[offset+1]}}else{val=buffer[offset];if(offset+1<buffer.length){val|=buffer[offset+1]<<8}}return val}Buffer.prototype.readUInt16LE=function(offset,noAssert){return readUInt16(this,offset,false,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return readUInt16(this,offset,true,noAssert)};function readUInt32(buffer,offset,isBigEndian,noAssert){var val=0;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return 0;if(isBigEndian){if(offset+1<buffer.length)val=buffer[offset+1]<<16;if(offset+2<buffer.length)val|=buffer[offset+2]<<8;if(offset+3<buffer.length)val|=buffer[offset+3];val=val+(buffer[offset]<<24>>>0)}else{if(offset+2<buffer.length)val=buffer[offset+2]<<16;if(offset+1<buffer.length)val|=buffer[offset+1]<<8;val|=buffer[offset];if(offset+3<buffer.length)val=val+(buffer[offset+3]<<24>>>0)}return val}Buffer.prototype.readUInt32LE=function(offset,noAssert){return readUInt32(this,offset,false,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return readUInt32(this,offset,true,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){var buffer=this;var neg;if(!noAssert){assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to read beyond buffer length")}if(offset>=buffer.length)return;neg=buffer[offset]&128;if(!neg){return buffer[offset]}return(255-buffer[offset]+1)*-1};function readInt16(buffer,offset,isBigEndian,noAssert){var neg,val;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to read beyond buffer length")}val=readUInt16(buffer,offset,isBigEndian,noAssert);neg=val&32768;if(!neg){return val}return(65535-val+1)*-1}Buffer.prototype.readInt16LE=function(offset,noAssert){return readInt16(this,offset,false,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return readInt16(this,offset,true,noAssert)};function readInt32(buffer,offset,isBigEndian,noAssert){var neg,val;if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}val=readUInt32(buffer,offset,isBigEndian,noAssert);neg=val&2147483648;if(!neg){return val}return(4294967295-val+1)*-1}Buffer.prototype.readInt32LE=function(offset,noAssert){return readInt32(this,offset,false,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return readInt32(this,offset,true,noAssert)};function readFloat(buffer,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset+3<buffer.length,"Trying to read beyond buffer length")}return require("./buffer_ieee754").readIEEE754(buffer,offset,isBigEndian,23,4)}Buffer.prototype.readFloatLE=function(offset,noAssert){return readFloat(this,offset,false,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return readFloat(this,offset,true,noAssert)};function readDouble(buffer,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset+7<buffer.length,"Trying to read beyond buffer length")}return require("./buffer_ieee754").readIEEE754(buffer,offset,isBigEndian,52,8)}Buffer.prototype.readDoubleLE=function(offset,noAssert){return readDouble(this,offset,false,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return readDouble(this,offset,true,noAssert)};function verifuint(value,max){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value>=0,"specified a negative value for writing an unsigned value");assert.ok(value<=max,"value is larger than maximum value for type");assert.ok(Math.floor(value)===value,"value has a fractional component")}Buffer.prototype.writeUInt8=function(value,offset,noAssert){var buffer=this;if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"trying to write beyond buffer length");verifuint(value,255)}if(offset<buffer.length){buffer[offset]=value}};function writeUInt16(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"trying to write beyond buffer length");verifuint(value,65535)}for(var i=0;i<Math.min(buffer.length-offset,2);i++){buffer[offset+i]=(value&255<<8*(isBigEndian?1-i:i))>>>(isBigEndian?1-i:i)*8}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){writeUInt16(this,value,offset,false,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){writeUInt16(this,value,offset,true,noAssert)};function writeUInt32(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"trying to write beyond buffer length");verifuint(value,4294967295)}for(var i=0;i<Math.min(buffer.length-offset,4);i++){buffer[offset+i]=value>>>(isBigEndian?3-i:i)*8&255}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){writeUInt32(this,value,offset,true,noAssert)};function verifsint(value,max,min){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value<=max,"value larger than maximum allowed value");assert.ok(value>=min,"value smaller than minimum allowed value");assert.ok(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert.ok(typeof value=="number","cannot write a non-number as a number");assert.ok(value<=max,"value larger than maximum allowed value");assert.ok(value>=min,"value smaller than minimum allowed value")}Buffer.prototype.writeInt8=function(value,offset,noAssert){var buffer=this;if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset<buffer.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(value>=0){buffer.writeUInt8(value,offset,noAssert)}else{buffer.writeUInt8(255+value+1,offset,noAssert)}};function writeInt16(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+1<buffer.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}if(value>=0){writeUInt16(buffer,value,offset,isBigEndian,noAssert)}else{writeUInt16(buffer,65535+value+1,offset,isBigEndian,noAssert)}}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){writeInt16(this,value,offset,false,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){writeInt16(this,value,offset,true,noAssert)};function writeInt32(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}if(value>=0){writeUInt32(buffer,value,offset,isBigEndian,noAssert)}else{writeUInt32(buffer,4294967295+value+1,offset,isBigEndian,noAssert)}}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){writeInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){writeInt32(this,value,offset,true,noAssert)};function writeFloat(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+3<buffer.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}require("./buffer_ieee754").writeIEEE754(buffer,value,offset,isBigEndian,23,4)}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){writeFloat(this,value,offset,false,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){writeFloat(this,value,offset,true,noAssert)};function writeDouble(buffer,value,offset,isBigEndian,noAssert){if(!noAssert){assert.ok(value!==undefined&&value!==null,"missing value");assert.ok(typeof isBigEndian==="boolean","missing or invalid endian");assert.ok(offset!==undefined&&offset!==null,"missing offset");assert.ok(offset+7<buffer.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}require("./buffer_ieee754").writeIEEE754(buffer,value,offset,isBigEndian,52,8)}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){writeDouble(this,value,offset,true,noAssert)}},{"./buffer_ieee754":1,assert:6,"base64-js":4}],"buffer-browserify":[function(require,module,exports){module.exports=require("q9TxCC")},{}],4:[function(require,module,exports){(function(exports){"use strict";var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw"Invalid string. Length must be a multiple of 4"}placeHolders=b64.indexOf("=");placeHolders=placeHolders>0?b64.length-placeHolders:0;arr=[];l=placeHolders>0?b64.length-4:b64.length;for(i=0,j=0;i<l;i+=4,j+=3){tmp=lookup.indexOf(b64[i])<<18|lookup.indexOf(b64[i+1])<<12|lookup.indexOf(b64[i+2])<<6|lookup.indexOf(b64[i+3]);arr.push((tmp&16711680)>>16);arr.push((tmp&65280)>>8);arr.push(tmp&255)}if(placeHolders===2){tmp=lookup.indexOf(b64[i])<<2|lookup.indexOf(b64[i+1])>>4;arr.push(tmp&255)}else if(placeHolders===1){tmp=lookup.indexOf(b64[i])<<10|lookup.indexOf(b64[i+1])<<4|lookup.indexOf(b64[i+2])>>2;arr.push(tmp>>8&255);arr.push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=lookup[temp>>2];output+=lookup[temp<<4&63];output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=lookup[temp>>10];output+=lookup[temp>>4&63];output+=lookup[temp<<2&63];output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],5:[function(require,module,exports){var toString=Object.prototype.toString;var hasOwnProperty=Object.prototype.hasOwnProperty;function isArray(xs){return toString.call(xs)==="[object Array]"}exports.isArray=typeof Array.isArray==="function"?Array.isArray:isArray;exports.indexOf=function indexOf(xs,x){if(xs.indexOf)return xs.indexOf(x);for(var i=0;i<xs.length;i++){if(x===xs[i])return i}return-1};exports.filter=function filter(xs,fn){if(xs.filter)return xs.filter(fn);var res=[];for(var i=0;i<xs.length;i++){if(fn(xs[i],i,xs))res.push(xs[i])}return res};exports.forEach=function forEach(xs,fn,self){if(xs.forEach)return xs.forEach(fn,self);for(var i=0;i<xs.length;i++){fn.call(self,xs[i],i,xs)}};exports.map=function map(xs,fn){if(xs.map)return xs.map(fn);var out=new Array(xs.length);for(var i=0;i<xs.length;i++){out[i]=fn(xs[i],i,xs)}return out};exports.reduce=function reduce(array,callback,opt_initialValue){if(array.reduce)return array.reduce(callback,opt_initialValue);var value,isValueSet=false;if(2<arguments.length){value=opt_initialValue;isValueSet=true}for(var i=0,l=array.length;l>i;++i){if(array.hasOwnProperty(i)){if(isValueSet){value=callback(value,array[i],i,array)}else{value=array[i];isValueSet=true}}}return value};if("ab".substr(-1)!=="b"){exports.substr=function(str,start,length){if(start<0)start=str.length+start;return str.substr(start,length)}}else{exports.substr=function(str,start,length){return str.substr(start,length)}}exports.trim=function(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")};exports.bind=function(){var args=Array.prototype.slice.call(arguments);var fn=args.shift();if(fn.bind)return fn.bind.apply(fn,args);var self=args.shift();return function(){fn.apply(self,args.concat([Array.prototype.slice.call(arguments)]))}};function create(prototype,properties){var object;if(prototype===null){object={__proto__:null}}else{if(typeof prototype!=="object"){throw new TypeError("typeof prototype["+typeof prototype+"] != 'object'")}var Type=function(){};Type.prototype=prototype;object=new Type;object.__proto__=prototype}if(typeof properties!=="undefined"&&Object.defineProperties){Object.defineProperties(object,properties)}return object}exports.create=typeof Object.create==="function"?Object.create:create;function notObject(object){return typeof object!="object"&&typeof object!="function"||object===null}function keysShim(object){if(notObject(object)){throw new TypeError("Object.keys called on a non-object")}var result=[];for(var name in object){if(hasOwnProperty.call(object,name)){result.push(name)}}return result}function propertyShim(object){if(notObject(object)){throw new TypeError("Object.getOwnPropertyNames called on a non-object")}var result=keysShim(object);if(exports.isArray(object)&&exports.indexOf(object,"length")===-1){result.push("length")}return result}var keys=typeof Object.keys==="function"?Object.keys:keysShim;var getOwnPropertyNames=typeof Object.getOwnPropertyNames==="function"?Object.getOwnPropertyNames:propertyShim;if((new Error).hasOwnProperty("description")){var ERROR_PROPERTY_FILTER=function(obj,array){if(toString.call(obj)==="[object Error]"){array=exports.filter(array,function(name){return name!=="description"&&name!=="number"&&name!=="message"})}return array};exports.keys=function(object){return ERROR_PROPERTY_FILTER(object,keys(object))};exports.getOwnPropertyNames=function(object){return ERROR_PROPERTY_FILTER(object,getOwnPropertyNames(object))}}else{exports.keys=keys;exports.getOwnPropertyNames=getOwnPropertyNames}function valueObject(value,key){return{value:value[key]}}if(typeof Object.getOwnPropertyDescriptor==="function"){try{Object.getOwnPropertyDescriptor({a:1},"a");exports.getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor}catch(e){exports.getOwnPropertyDescriptor=function(value,key){try{return Object.getOwnPropertyDescriptor(value,key)}catch(e){return valueObject(value,key)}}}}else{exports.getOwnPropertyDescriptor=valueObject}},{}],6:[function(require,module,exports){var util=require("util");var shims=require("_shims");var pSlice=Array.prototype.slice;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;this.message=options.message||getMessage(this)};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&(isNaN(value)||!isFinite(value))){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}try{var ka=shims.keys(a),kb=shims.keys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}}},{_shims:5,util:7}],7:[function(require,module,exports){var shims=require("_shims");var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};shims.forEach(array,function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=shims.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=shims.getOwnPropertyNames(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}shims.forEach(keys,function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=shims.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(shims.indexOf(ctx.seen,desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=shims.reduce(output,function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return shims.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;
function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&objectToString(e)==="[object Error]"}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;function isBuffer(arg){return arg instanceof Buffer}exports.isBuffer=isBuffer;function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=function(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=shims.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})};exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=shims.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}},{_shims:5}]},{},[]);module.exports=require("buffer-browserify")},{}],11:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){if(ev.source===window&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],12:[function(require,module,exports){"use strict";var eve=require("eve");var rePrefixed=/^glue\./;["on","once","off"].forEach(function(method){exports[method]=function(name,handler){if(!rePrefixed.test(name)){name="glue."+name}eve[method](name,handler)}})},{eve:18}],13:[function(require,module,exports){"use strict";var async=require("async");var url=require("url");var eve=require("eve");var qsa=require("fdom/qsa");var on=require("fdom/on");var extend=require("cog/extend");var defaults=require("cog/defaults");var logger=require("cog/logger");var debug=logger("glue");var signaller=require("rtc-signaller");var media=require("rtc-media");var captureConfig=require("rtc-captureconfig");var transform=require("sdp-transform");var resetEl=require("rtc-core/reset");var reSep=/[\s\,]\s*/;var reTrailingSlash=/\/$/;var canGetSources=typeof MediaStreamTrack!="undefined"&&MediaStreamTrack.getSources;var config=defaults({},require("fdom/meta")(/^rtc-(.*)$/),{room:location.hash.slice(1),signalhost:location.origin||"http://rtc.io/switchboard/"});var SessionManager=require("./sessionmanager");var sessionMgr;var sources;require("cog/logger").enable("*");var glue=module.exports=function(scope,opts){var startupOps=[];var debugTarget;var peers=qsa("*[rtc-peer]",scope).map(initPeer);if(peers.length>0){startupOps.push(loadPrimus)}extend(config,opts);debugTarget=(config||{}).debug;if(debugTarget){if(debugTarget===true){logger.enable("*")}else if(Array.isArray(debugTarget)){logger.enable.apply(logger,debugTarget)}else{logger.enable(debugTarget)}}async.parallel(startupOps,function(err){debug("startup ops completed, starting glue",config);eve("glue.ready");if(!config.room){config.room=generateRoomName()}sessionMgr=typeof Primus!="undefined"&&new SessionManager(config);if(sessionMgr){sessionMgr.once("active",function(){qsa("*[rtc-capture]",scope).forEach(initCapture);if(peers.length>0){sessionMgr.announce()}})}else{qsa("*[rtc-capture]",scope).forEach(initCapture)}})};glue.events=require("./events");glue.config=config;if(typeof window!="undefined"){on("load",window,function(){if(config.autoload===undefined||config.autoload){glue()}})}function initPeer(el){var propValue=el.getAttribute("rtc-peer");var targetStream=el.getAttribute("rtc-stream");var peerRoles=propValue?propValue.split(reSep):["*"];var data=el._rtc||(el._rtc={});function attachStream(stream){debug("attaching stream");media(stream).render(el);data.streamId=stream.id}function addStream(stream,peer){if(data.streamId){return}if(targetStream){debug("requesting stream data");sessionMgr.getStreamData(stream,function(data){debug("got stream data",data);if(data&&data.name===targetStream){attachStream(stream)}})}else{attachStream(stream)}}peerRoles.forEach(function(role){eve.on("glue.peer.active."+role,function(peer,peerId){if(data.peerId){return}debug("peer active",peer.getRemoteStreams());data.peerId=peerId;[].slice.call(peer.getRemoteStreams()).forEach(addStream);peer.addEventListener("addstream",function(evt){addStream(evt.stream,peer)})})});eve.on("glue.peer.leave",function(peer,peerId){if(data.peerId===peerId){resetEl(el);data=el._rtc={}}});return el}function initCapture(el){var configText=el.getAttribute("rtc-capture")||"";var res=el.getAttribute("rtc-resolution")||el.getAttribute("rtc-res");var fps=el.getAttribute("rtc-fps");if(res){configText+=" min:"+res+" max:"+res}if(fps){configText+=" minfps:"+fps+" maxfps:"+fps}el.capture=enableCapture(el,captureConfig(configText));el.capture(function(stream){if(sessionMgr){sessionMgr.broadcast(stream,{name:el.id})}})}function enableCapture(el,config){function cap(callback){var stream=media({constraints:config.toConstraints({sources:sources})});stream.render(el);stream.on("error",function(err){console.log("Error attempting to capture media, requested constraints",stream.constraints)});stream.on("capture",function(stream){el.dispatchEvent(new CustomEvent("capture",{detail:{stream:stream}}));if(typeof callback=="function"){callback(stream)}})}return function(callback){if(sources||!canGetSources){return cap(callback)}MediaStreamTrack.getSources(function(s){sources=s;cap(callback)})}}function generateRoomName(){location.hash=Math.pow(2,53)*Math.random();return location.hash.slice(1)}function loadPrimus(callback){return signaller.loadPrimus(config.signalhost,callback)}},{"./events":12,"./sessionmanager":69,async:14,"cog/defaults":15,"cog/extend":16,"cog/logger":17,eve:18,"fdom/meta":19,"fdom/on":20,"fdom/qsa":21,"rtc-captureconfig":22,"rtc-core/reset":24,"rtc-media":25,"rtc-signaller":31,"sdp-transform":65,url:5}],14:[function(require,module,exports){var process=require("__browserify_process");(function(){var async={};var root,previous_async;root=this;if(root!=null){previous_async=root.async}async.noConflict=function(){root.async=previous_async;return async};function only_once(fn){var called=false;return function(){if(called)throw new Error("Callback was already called.");called=true;fn.apply(root,arguments)}}var _each=function(arr,iterator){if(arr.forEach){return arr.forEach(iterator)}for(var i=0;i<arr.length;i+=1){iterator(arr[i],i,arr)}};var _map=function(arr,iterator){if(arr.map){return arr.map(iterator)}var results=[];_each(arr,function(x,i,a){results.push(iterator(x,i,a))});return results};var _reduce=function(arr,iterator,memo){if(arr.reduce){return arr.reduce(iterator,memo)}_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo};var _keys=function(obj){if(Object.keys){return Object.keys(obj)}var keys=[];for(var k in obj){if(obj.hasOwnProperty(k)){keys.push(k)}}return keys};if(typeof process==="undefined"||!process.nextTick){if(typeof setImmediate==="function"){async.nextTick=function(fn){setImmediate(fn)};async.setImmediate=async.nextTick}else{async.nextTick=function(fn){setTimeout(fn,0)};async.setImmediate=async.nextTick}}else{async.nextTick=process.nextTick;if(typeof setImmediate!=="undefined"){async.setImmediate=setImmediate}else{async.setImmediate=async.nextTick}}async.each=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;_each(arr,function(x){iterator(x,only_once(function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback(null)}}}))})};async.forEach=async.each;async.eachSeries=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;var iterate=function(){iterator(arr[completed],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback(null)}else{iterate()}}})};iterate()};async.forEachSeries=async.eachSeries;async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])};async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){callback=callback||function(){};if(!arr.length||limit<=0){return callback()}var completed=0;var started=0;var running=0;(function replenish(){if(completed>=arr.length){return callback()}while(running<limit&&started<arr.length){started+=1;running+=1;iterator(arr[started-1],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed>=arr.length){callback()}else{replenish()}}})}})()}};var doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}};var doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}};var doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}};var _asyncMap=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v;callback(err)})},function(err){callback(err,results)})};async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.inject=async.reduce;async.foldl=async.reduce;async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)};async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter);async.filterSeries=doSeries(_filter);async.select=async.filter;async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(!v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject);async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){if(result){main_callback(x);main_callback=function(){}}else{callback()}})},function(err){main_callback()})};async.detect=doParallel(_detect);async.detectSeries=doSeries(_detect);async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(v){main_callback(true);main_callback=function(){}}callback()})},function(err){main_callback(false)})};async.any=async.some;async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(!v){main_callback(false);main_callback=function(){}}callback()})},function(err){main_callback(true)})};async.all=async.every;async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err){callback(err)}else{callback(null,{value:x,criteria:criteria})}})},function(err,results){if(err){return callback(err)}else{var fn=function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))}})};async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);if(!keys.length){return callback(null)}var results={};var listeners=[];var addListener=function(fn){listeners.unshift(fn)};var removeListener=function(fn){for(var i=0;i<listeners.length;i+=1){if(listeners[i]===fn){listeners.splice(i,1);return}}};var taskComplete=function(){_each(listeners.slice(0),function(fn){fn()})};addListener(function(){if(_keys(results).length===keys.length){callback(null,results);callback=function(){}}});_each(keys,function(k){var task=tasks[k]instanceof Function?[tasks[k]]:tasks[k];var taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}if(err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]});safeResults[k]=args;callback(err,safeResults);callback=function(){}}else{results[k]=args;async.setImmediate(taskComplete)}};var requires=task.slice(0,Math.abs(task.length-1))||[];var ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)&&!results.hasOwnProperty(k)};if(ready()){task[task.length-1](taskCallback,results)}else{var listener=function(){if(ready()){removeListener(listener);task[task.length-1](taskCallback,results)}};addListener(listener)}})};async.waterfall=function(tasks,callback){callback=callback||function(){};if(tasks.constructor!==Array){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length){return callback()}var wrapIterator=function(iterator){return function(err){if(err){callback.apply(null,arguments);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);var next=iterator.next();if(next){args.push(wrapIterator(next))}else{args.push(callback)}async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){eachfn.map(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)};async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)};async.series=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){async.mapSeries(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){if(tasks.length){tasks[index].apply(null,arguments)}return fn.next()};fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn};return makeCallback(0)};async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]);cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){if(test()){iterator(function(err){if(err){return callback(err)}async.whilst(test,iterator,callback)})}else{callback()}};async.doWhilst=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}if(test()){async.doWhilst(iterator,test,callback)}else{callback()}})};async.until=function(test,iterator,callback){if(!test()){iterator(function(err){if(err){return callback(err)}async.until(test,iterator,callback)})}else{callback()}};async.doUntil=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}if(!test()){async.doUntil(iterator,test,callback)}else{callback()}})};async.queue=function(worker,concurrency){if(concurrency===undefined){concurrency=1}function _insert(q,data,pos,callback){if(data.constructor!==Array){data=[data]}_each(data,function(task){var item={data:task,callback:typeof callback==="function"?callback:null};if(pos){q.tasks.unshift(item)}else{q.tasks.push(item)}if(q.saturated&&q.tasks.length===concurrency){q.saturated()}async.setImmediate(q.process)})}var workers=0;var q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,push:function(data,callback){_insert(q,data,false,callback)},unshift:function(data,callback){_insert(q,data,true,callback)},process:function(){if(workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();if(q.empty&&q.tasks.length===0){q.empty()}workers+=1;var next=function(){workers-=1;if(task.callback){task.callback.apply(task,arguments)}if(q.drain&&q.tasks.length+workers===0){q.drain()}q.process()};var cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers}};return q};async.cargo=function(worker,payload){var working=false,tasks=[];var cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,push:function(data,callback){if(data.constructor!==Array){data=[data]}_each(data,function(task){tasks.push({data:task,callback:typeof callback==="function"?callback:null});if(cargo.saturated&&tasks.length===payload){cargo.saturated()}});async.setImmediate(cargo.process)},process:function process(){if(working)return;if(tasks.length===0){if(cargo.drain)cargo.drain();return}var ts=typeof payload==="number"?tasks.splice(0,payload):tasks.splice(0);var ds=_map(ts,function(task){return task.data});if(cargo.empty)cargo.empty();working=true;worker(ds,function(){working=false;var args=arguments;_each(ts,function(data){if(data.callback){data.callback.apply(null,args)}});process()})},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);if(typeof console!=="undefined"){if(err){if(console.error){console.error(err)}}else if(console[name]){_each(args,function(x){console[name](x)})}}}]))}};async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var key=hasher.apply(null,args);if(key in memo){callback.apply(null,memo[key])}else if(key in queues){queues[key].push(callback)}else{queues[key]=[callback];fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i].apply(null,arguments)}}]))}};memoized.memo=memo;memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}};async.times=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.map(counter,iterator,callback)};async.timesSeries=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.mapSeries(counter,iterator,callback)};async.compose=function(){var fns=Array.prototype.reverse.call(arguments);return function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0];var nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}};var _applyEach=function(eachfn,fns){var go=function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}else{return go}};async.applyEach=doParallel(_applyEach);async.applyEachSeries=doSeries(_applyEach);async.forever=function(fn,callback){function next(err){if(err){if(callback){return callback(err)}throw err}fn(next)}next()};if(typeof define!=="undefined"&&define.amd){define([],function(){return async})}else if(typeof module!=="undefined"&&module.exports){module.exports=async}else{root.async=async}})()},{__browserify_process:11}],15:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],16:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],17:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],18:[function(require,module,exports){(function(glob){var version="0.4.2",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b},current_event,stop,events={n:{}},eve=function(name,scope){name=String(name);var e=events,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},out=[],ce=current_event,errors=[];current_event=name;stop=0;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i]}}indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];out.push(l.apply(scope,args));if(stop){stop=oldstop;return out}}for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){out.push(l.apply(scope,args));if(stop){break}do{z++;l=queue[indexed[z]];l&&out.push(l.apply(scope,args));if(stop){break}}while(l)}else{queue[l.zIndex]=l}}else{out.push(l.apply(scope,args));if(stop){break}}}stop=oldstop;current_event=ce;return out.length?out:null};eve._events=events;eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[])}}}es=nes}return out};eve.on=function(name,f){name=String(name);if(typeof f!="function"){return function(){}}var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;e=e.hasOwnProperty(names[i])&&e[names[i]]||(e[names[i]]={n:{}})}e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun}e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex}}};eve.f=function(event){var attrs=[].slice.call(arguments,1);return function(){eve.apply(null,[event,null].concat(attrs).concat([].slice.call(arguments,0)))}};eve.stop=function(){stop=1};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event)}return current_event};eve.nts=function(){return current_event.split(separator)};eve.off=eve.unbind=function(name,f){if(!name){eve._events=events={n:{}};return}var names=name.split(separator),e,key,splice,i,ii,j,jj,cur=[events];for(i=0,ii=names.length;i<ii;i++){for(j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]])}}else{for(key in e)if(e[has](key)){splice.push(e[key])}}cur.splice.apply(cur,splice)}}for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(j=0,jj=e.f.length;j<jj;j++)if(e.f[j]==f){e.f.splice(j,1);break}!e.f.length&&delete e.f}for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(j=0,jj=funcs.length;j<jj;j++)if(funcs[j]==f){funcs.splice(j,1);break}!funcs.length&&delete e.n[key].f}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f}}e=e.n}}};eve.once=function(name,f){var f2=function(){eve.unbind(name,f2);return f.apply(this,arguments)};return eve.on(name,f2)};eve.version=version;eve.toString=function(){return"You are running Eve "+version};typeof module!="undefined"&&module.exports?module.exports=eve:typeof define!="undefined"?define("eve",[],function(){return eve}):glob.eve=eve})(this)},{}],19:[function(require,module,exports){"use strict";var qsa=require("./qsa");var reBool=/^(true|false)$/i;module.exports=function(regex){var data={};qsa("meta[name]").forEach(function(tag){var name=tag.getAttribute("name");var match=regex?regex.exec(name):[name,name];if(match){data[match[1]||match[0]]=coerce(tag.getAttribute("content")||"")}});return data};function coerce(value){value=parseFloat(value)||value;if(reBool.test(value)){value=value=="true"}return value}},{"./qsa":21}],20:[function(require,module,exports){"use strict";module.exports=function(name,el,callback){function bind(t,trigger){var buffered=[];function handleEvent(evt){if(typeof trigger=="function"){return trigger(null,evt)}buffered[buffered.length]=evt}t.addEventListener(name,handleEvent);return typeof trigger=="function"?handleEvent:function(cb){trigger=cb;if(buffered.length>0){buffered.splice(0).forEach(function(evt){cb(null,evt)})}}}return el?bind(el,callback):bind}},{}],21:[function(require,module,exports){"use strict";var classSelectorRE=/^\.([\w\-]+)$/;var idSelectorRE=/^#([\w\-]+)$/;var tagSelectorRE=/^[\w\-]+$/;module.exports=function(selector,scope){var idSearch;scope=scope||document;idSearch=scope===document&&idSelectorRE.test(selector);return idSearch?[scope.getElementById(RegExp.$1)]:Array.prototype.slice.call(classSelectorRE.test(selector)?scope.getElementsByClassName(RegExp.$1):tagSelectorRE.test(selector)?scope.getElementsByTagName(selector):scope.querySelectorAll(selector))}},{}],22:[function(require,module,exports){"use strict";var reSeparator=/[\,\s]\s*/;var offFlags=["false","none","off"];module.exports=function(input){var config=new CaptureConfig;(input||"").split(reSeparator).forEach(function(directive){var parts=directive.split(":");var method=config[(parts[0]||"").toLowerCase()];if(typeof method=="function"){method.apply(config,parts.slice(1))}});return config};function CaptureConfig(){if(!(this instanceof CaptureConfig)){return new CaptureConfig}this.cfg={microphone:true}}CaptureConfig.prototype.camera=function(index){this.cfg.camera=trueOrValue(index)};CaptureConfig.prototype.microphone=function(index){this.cfg.microphone=trueOrValue(index)};CaptureConfig.prototype.screen=function(){delete this.cfg.microphone;this.cfg.screen=true};CaptureConfig.prototype.max=function(data){var res;if(data.slice(-3).toLowerCase()=="fps"){return this.maxfps(data)}res=this._parseRes(data);this.cfg.res=this.cfg.res||{};this.cfg.res.max=res};CaptureConfig.prototype.maxfps=function(data){this.cfg.fps=this.cfg.fps||{};this.cfg.fps.max=parseFloat(data.slice(0,-3))};CaptureConfig.prototype.min=function(data){var res;if(data.slice(-3).toLowerCase()=="fps"){return this.minfps(data)}res=this._parseRes(data);this.cfg.res=this.cfg.res||{};this.cfg.res.min=res};CaptureConfig.prototype.minfps=function(data){this.cfg.fps=this.cfg.fps||{};this.cfg.fps.min=parseFloat(data.slice(0,-3))};CaptureConfig.prototype.toConstraints=function(opts){var cfg=this.cfg;var constraints={audio:cfg.microphone===true||typeof cfg.microphone=="number"&&cfg.microphone>=0,video:cfg.camera===true||cfg.screen||typeof cfg.camera=="number"&&cfg.camera>=0};var m={video:{},audio:{}};var o={video:[],audio:[]};var sources=(opts||{}).sources||[];var cameras=sources.filter(function(info){return info&&info.kind==="video"});var microphones=sources.filter(function(info){return info&&info.kind==="audio"});var selectedSource;function complexConstraints(target){if(constraints[target]&&typeof constraints[target]!="object"){constraints[target]={mandatory:m[target],optional:o[target]}}}if(cfg.fps){complexConstraints("video");cfg.fps.min&&(m.video.minFrameRate=cfg.fps.min);cfg.fps.max&&(m.video.maxFrameRate=cfg.fps.max)}if(cfg.res&&cfg.res.min){complexConstraints("video");m.video.minWidth=cfg.res.min.w;m.video.minHeight=cfg.res.min.h}if(cfg.res&&cfg.res.max){complexConstraints("video");m.video.maxWidth=cfg.res.max.w;m.video.maxHeight=cfg.res.max.h}if(typeof cfg.camera=="number"&&cameras.length){selectedSource=cameras[cfg.camera];if(selectedSource){complexConstraints("video");o.video.push({sourceId:selectedSource.id})}}if(typeof cfg.microphone=="number"&&microphones.length){selectedSource=microphones[cfg.microphone];if(selectedSource){complexConstraints("audio");o.audio.push({sourceId:selectedSource.id})}}if(typeof cfg.screen!="undefined"){complexConstraints("video");m.video.chromeMediaSource="screen"}return constraints};CaptureConfig.prototype._parseRes=function(data){var parts=data.split("x");if(parts.length<2){throw new Error("Invalid resolution specification: "+data)}return{w:parseInt(parts[0],10),h:parseInt(parts[1],10)}
};function trueOrValue(val){if(typeof val=="string"&&offFlags.indexOf(val.toLowerCase())>=0){return false}return val===undefined||val===""||parseInt(val||0,10)}},{}],23:[function(require,module,exports){"use strict";var detect=module.exports=function(target,prefixes){var prefixIdx;var prefix;var testName;var hostObject=this||(typeof window!="undefined"?window:undefined);if(!hostObject){return}prefixes=(prefixes||["ms","o","moz","webkit"]).concat("");for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();return hostObject[target]=hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;detect.browser=undefined},{}],24:[function(require,module,exports){"use strict";module.exports=function(el){el.src=null;if(el.mozSrcObject){el.mozSrcObject=null}if(el.currentSrc){el.currentSrc=null}return el}},{}],25:[function(require,module,exports){"use strict";var debug=require("cog/logger")("media");var extend=require("cog/extend");var detect=require("rtc-core/detect");var EventEmitter=require("events").EventEmitter;var util=require("util");navigator.getUserMedia=navigator.getUserMedia||detect.call(navigator,"getUserMedia");window.URL=window.URL||detect("URL");window.MediaStream=detect("MediaStream");function Media(opts){if(!(this instanceof Media)){return new Media(opts)}EventEmitter.call(this);if(opts&&opts instanceof MediaStream){opts={stream:opts,capture:false,muted:false}}if(opts&&(opts.audio||opts.video)){opts={constraints:opts}}opts=extend({},{capture:true,muted:true,constraints:{video:{mandatory:{},optional:[]},audio:true}},opts);this.constraints=opts.constraints;this.name=opts.name;this.stream=opts.stream||null;this.muted=typeof opts.muted=="undefined"||opts.muted;this._bindings=[];if(opts.capture){setTimeout(this.capture.bind(this),0)}}util.inherits(Media,EventEmitter);module.exports=Media;Media.prototype.capture=function(constraints,callback){var media=this;var handleEnd=this.emit.bind(this,"end");if(this.stream){return}if(typeof constraints=="function"){callback=constraints;constraints=this.constraints}if(typeof callback=="function"){this.once("capture",callback.bind(this))}navigator.getUserMedia(constraints||this.constraints,function(stream){if(typeof stream.addEventListener=="function"){stream.addEventListener("ended",handleEnd)}else{stream.onended=handleEnd}media.stream=stream;media.emit("capture",stream)},this._handleFail.bind(this))};Media.prototype.render=function(target,opts,callback){if(Array.isArray(target)){console.log("WARNING: rtc-media render (as of 1.x) expects a single target");target=target[0]}if(typeof opts=="function"){callback=opts;opts={}}opts=opts||{};target=this._prepareElement(opts,target);if(!this.stream){this.once("capture",this._bindStream.bind(this))}else{this._bindStream(this.stream)}if(typeof callback=="function"){this.once("render",callback)}return target};Media.prototype.stop=function(opts){var media=this;if(!this.stream){return}this._unbind(opts);this.stream.stop();this.once("capture",media._bindStream.bind(media));this.stream=null};Media.prototype._prepareElement=function(opts,element){var parent;var validElement=element instanceof HTMLVideoElement||element instanceof HTMLAudioElement;var preserveAspectRatio=typeof opts.preserveAspectRatio=="undefined"||opts.preserveAspectRatio;validElement=validElement||typeof element.play=="function"&&(typeof element.mozSrcObject!="undefined"||typeof element.src!="undefined");if(!validElement){parent=element;element=document.createElement("video");if(preserveAspectRatio){element.setAttribute("preserveAspectRatio","")}parent.appendChild(element);element.setAttribute("data-playing",false)}if(element&&this.muted){element.setAttribute("muted","")}this._bindings.push({el:element,opts:opts});return element};Media.prototype._bindStream=function(stream){var media=this;var elements=[];var waiting=[];function checkWaiting(){if(waiting.length===0&&elements.length>0){media.emit("render",elements[0]);elements.map(function(el){el.setAttribute("data-playing",true)})}}function playbackStarted(evt){var el=evt.target||evt.srcElement;var videoIndex=elements.indexOf(el);if(videoIndex>=0){waiting.splice(videoIndex,1)}el.removeEventListener("playing",playbackStarted);checkWaiting()}elements=this._bindings.map(function(binding){if(typeof binding.el.mozSrcObject!="undefined"){binding.el.mozSrcObject=stream}else{binding.el.src=media._createObjectURL(stream)||stream}if(typeof binding.el.play=="function"){binding.el.play()}return binding.el});waiting=elements.filter(function(el){return el.readyState<3});waiting.map(function(el){el.addEventListener("playing",playbackStarted,false)});checkWaiting()};Media.prototype._unbind=function(opts){opts=opts||{};this._bindings.forEach(function(binding){var element=binding.el;element.src=null;if(element.mozSrcObject){element.mozSrcObject=null}if(element.currentSrc){element.currentSrc=null}})};Media.prototype._createObjectURL=function(stream){try{return window.URL.createObjectURL(stream)}catch(e){}};Media.prototype._handleSuccess=function(stream){this.stream=stream;this.emit("stream",stream)};Media.prototype._handleFail=function(err){this.emit("error",err)}},{"cog/extend":16,"cog/logger":17,events:3,"rtc-core/detect":23,util:6}],26:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller-announce");var extend=require("cog/extend");var roles=["a","b"];module.exports=function(signaller){function copyData(target,source){if(target&&source){for(var key in source){if(key!="clock"){target[key]=source[key]}}}return target}return function(args,messageType,clock){var data=args[0];var peer;if(data&&data.id){peer=signaller.peers.get(data.id);if(peer){debug("signaller: "+signaller.id+" received update, data: ",data);copyData(peer.data,data);return signaller.emit("peer:update",data)}peer={id:data.id,roleIdx:[data.id,signaller.id].sort().indexOf(data.id),clock:clock||{a:0,b:0},data:{}};copyData(peer.data,data);signaller.peers.set(data.id,peer);if(!clock){signaller.to(data.id).send("/announce",signaller.attributes)}return signaller.emit("peer:announce",data,peer)}}}},{"cog/extend":32,"cog/logger":34}],27:[function(require,module,exports){"use strict";module.exports=function(signaller){return{announce:require("./announce")(signaller),leave:require("./leave")(signaller),lock:require("./lock")(signaller),unlock:require("./unlock")(signaller)}}},{"./announce":26,"./leave":28,"./lock":29,"./unlock":30}],28:[function(require,module,exports){"use strict";module.exports=function(signaller){return function(args){var data=args[0];var peer=signaller.peers.get(data&&data.id);if(peer){signaller.peers.delete(data.id)}signaller.emit("peer:leave",data.id,peer)}}},{}],29:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller-lock");var vc=require("vectorclock");var FastMap=require("collections/fast-map");module.exports=function(signaller){return function(args,messageType,clock,srcState){var clockComparison;var success=false;var label=args[0];if(!clock||!srcState){return}debug('received "'+label+'" lock request from src: '+srcState.id);clockComparison=vc.compare(clock,srcState.clock);success=!signaller.locks.get(label)||clockComparison>0||clockComparison===0&&srcState.roleIdx===0;debug("signaller "+signaller.id+" checking lock state");debug("clock value in message: ",clock);debug("cached peer clock state: ",srcState.clock);debug("clock comparison = "+clockComparison+" ok: "+success,srcState);if(success){srcState.locks=srcState.locks||new FastMap;srcState.locks.set(label,{id:args[1]||""})}signaller.to(srcState.id).send("/lockresult",{label:label,ok:success})}}},{"cog/logger":34,"collections/fast-map":36,vectorclock:55}],30:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller-lock");var vc=require("vectorclock");module.exports=function(signaller){return function(args,messageType,clock,srcState){var label=args[0];var ok=false;if(!clock||!srcState){return}debug('received "'+label+'" unlock request from src: '+srcState.id);if(srcState.locks){srcState.locks.delete(label);ok=true}signaller.to(srcState.id).send("/unlockresult",{label:label,ok:ok})}}},{"cog/logger":34,vectorclock:55}],31:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var EventEmitter=require("events").EventEmitter;var uuid=require("uuid");var extend=require("cog/extend");var FastMap=require("collections/fast-map");var vc=require("vectorclock");var sig=module.exports=function(messenger,opts){var signaller=new EventEmitter;var id=signaller.id=uuid.v4();var attributes=signaller.attributes={id:id};var peers=signaller.peers=new FastMap;var locks=signaller.locks=new FastMap;var dataEvent=(opts||{}).dataEvent||"data";var writeMethod=(opts||{}).writeMethod||"write";var closeMethod=(opts||{}).closeMethod||"close";var write=messenger[writeMethod];var close=messenger[closeMethod];var processor=require("./processor")(signaller);if(typeof write!="function"){throw new Error('provided messenger does not implement a "'+writeMethod+'" write method')}function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}var send=signaller.send=function(){var args=[].slice.call(arguments);var dataline=args.map(prepareArg).filter(Boolean).join("|");return write.call(messenger,dataline)};signaller.announce=function(data,sender){extend(attributes,data,{id:id});return(sender||send)("/announce",attributes)};signaller.leave=function(){send("/leave",{id:id});if(typeof close=="function"){close.call(messenger)}};signaller.lock=function(targetId,opts,callback){var peer=peers.get(targetId);var activeLock;var lockid=uuid.v4();var label;function handleLockResult(src,result){var ok=result&&result.ok;if(!src||src.id!==targetId){return}if(!result||result.label!==label){return}signaller.removeListener("lockresult",handleLockResult);if(ok){locks.set(label,activeLock={id:lockid})}else if(activeLock){locks.delete(label)}callback(ok?null:new Error("could not acquire lock"))}if(typeof opts=="function"){callback=opts;opts={}}callback=callback||function(){};if(!peer){return callback(new Error("unknown target id - cannot initiate lock"))}label=(opts||{}).label||(opts||{}).name||"default";activeLock=locks.get(label);if(activeLock&&!activeLock.provisional){return callback()}peer.locks=peer.locks||new FastMap;if(peer.locks.get(label)){return callback(new Error("remote lock in place, cannot request lock"))}locks.set(label,activeLock={id:lockid,provisional:true});signaller.on("lockresult",handleLockResult);signaller.to(targetId).send("/lock",label,lockid)};signaller.to=function(targetId){var sender=function(){var peer=signaller.peers.get(targetId);var args;if(!peer){throw new Error("Unknown peer: "+targetId)}args=["/to",targetId,{id:signaller.id,clock:peer.clock}].concat([].slice.call(arguments));vc.increment(peer,["a","b"][peer.roleIdx^1]);setTimeout(function(){var msg=args.map(prepareArg).filter(Boolean).join("|");debug("TX ("+targetId+"): ",msg);write.call(messenger,msg)},0)};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};signaller.unlock=function(targetId,opts,callback){var peer=peers.get(targetId);var label;function handleUnlockResult(src,result){var ok=result&&result.ok;if(!src||src.id!==targetId){return}if(!result||result.label!==label){return}signaller.removeListener("unlockresult",handleUnlockResult);if(ok){locks.delete(label)}callback(ok?null:new Error("could not release lock: "+label))}if(typeof opts=="function"){callback=opts;opts={}}callback=callback||function(){};label=(opts||{}).label||(opts||{}).name||"default";if(peer&&locks.get(label)){signaller.on("unlockresult",handleUnlockResult);signaller.to(targetId).send("/unlock",label,locks.get(label))}else{return callback(new Error("no local lock with label "+label))}};messenger.on(dataEvent,processor);return signaller};sig.loadPrimus=require("./primus-loader")},{"./primus-loader":56,"./processor":57,"cog/extend":32,"cog/logger":34,"collections/fast-map":36,events:3,uuid:54,vectorclock:55}],32:[function(require,module,exports){module.exports=require(16)},{}],33:[function(require,module,exports){"use strict";module.exports=function(input){var isString=typeof input=="string"||input instanceof String;var reNumeric=/^\-?\d+\.?\d*$/;var shouldParse;var firstChar;var lastChar;if(!isString||input.length<2){if(isString&&reNumeric.test(input)){return parseFloat(input)}return input}if(input==="true"||input==="false"){return input==="true"}if(input==="null"){return null}firstChar=input.charAt(0);lastChar=input.charAt(input.length-1);shouldParse=firstChar=="{"&&lastChar=="}"||firstChar=="["&&lastChar=="]";if(shouldParse){try{return JSON.parse(input)}catch(e){}}return reNumeric.test(input)?parseFloat(input):input}},{}],34:[function(require,module,exports){module.exports=require(17)},{}],35:[function(require,module,exports){"use strict";var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=Dict;function Dict(values,getDefault){if(!(this instanceof Dict)){return new Dict(values,getDefault)}getDefault=getDefault||Function.noop;this.getDefault=getDefault;this.store={};this.length=0;this.addEach(values)}Dict.Dict=Dict;function mangle(key){return"~"+key}function unmangle(mangled){return mangled.slice(1)}Object.addEach(Dict.prototype,GenericCollection.prototype);Object.addEach(Dict.prototype,GenericMap.prototype);Object.addEach(Dict.prototype,PropertyChanges.prototype);Dict.prototype.constructClone=function(values){return new this.constructor(values,this.mangle,this.getDefault)};Dict.prototype.assertString=function(key){if(typeof key!=="string"){throw new TypeError("key must be a string but Got "+key)}};Dict.prototype.get=function(key,defaultValue){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){return this.store[mangled]}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};Dict.prototype.set=function(key,value){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesBeforeMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return false}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}this.length++;this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return true}};Dict.prototype.has=function(key){this.assertString(key);var mangled=mangle(key);return mangled in this.store};Dict.prototype["delete"]=function(key){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangle(key)];this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};Dict.prototype.clear=function(){var key,mangled;for(mangled in this.store){key=unmangle(mangled);if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangled];if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}}this.length=0};Dict.prototype.reduce=function(callback,basis,thisp){for(var mangled in this.store){basis=callback.call(thisp,basis,this.store[mangled],unmangle(mangled),this)}return basis};Dict.prototype.reduceRight=function(callback,basis,thisp){var self=this;var store=this.store;return Object.keys(this.store).reduceRight(function(basis,mangled){return callback.call(thisp,basis,store[mangled],unmangle(mangled),self)},basis)};Dict.prototype.one=function(){var key;for(key in this.store){return this.store[key]}}},{"./generic-collection":38,"./generic-map":39,"./listen/property-changes":44,"./shim":51}],36:[function(require,module,exports){"use strict";var Shim=require("./shim");var Set=require("./fast-set");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=FastMap;function FastMap(values,equals,hash,getDefault){if(!(this instanceof FastMap)){return new FastMap(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.store=new Set(undefined,function keysEqual(a,b){return equals(a.key,b.key)},function keyHash(item){return hash(item.key)});this.length=0;this.addEach(values)}FastMap.FastMap=FastMap;Object.addEach(FastMap.prototype,GenericCollection.prototype);Object.addEach(FastMap.prototype,GenericMap.prototype);Object.addEach(FastMap.prototype,PropertyChanges.prototype);FastMap.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastMap.prototype.log=function(charmap,stringify){stringify=stringify||this.stringify;this.store.log(charmap,stringify)};FastMap.prototype.stringify=function(item,leader){return leader+JSON.stringify(item.key)+": "+JSON.stringify(item.value)}},{"./fast-set":37,"./generic-collection":38,"./generic-map":39,"./listen/property-changes":44,"./shim":51}],37:[function(require,module,exports){"use strict";var Shim=require("./shim");var Dict=require("./dict");var List=require("./list");var GenericCollection=require("./generic-collection");var GenericSet=require("./generic-set");var TreeLog=require("./tree-log");var PropertyChanges=require("./listen/property-changes");var object_has=Object.prototype.hasOwnProperty;module.exports=FastSet;function FastSet(values,equals,hash,getDefault){if(!(this instanceof FastSet)){return new FastSet(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.buckets=new this.Buckets(null,this.Bucket);this.length=0;this.addEach(values)}FastSet.FastSet=FastSet;Object.addEach(FastSet.prototype,GenericCollection.prototype);Object.addEach(FastSet.prototype,GenericSet.prototype);Object.addEach(FastSet.prototype,PropertyChanges.prototype);FastSet.prototype.Buckets=Dict;FastSet.prototype.Bucket=List;FastSet.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastSet.prototype.has=function(value){var hash=this.contentHash(value);return this.buckets.get(hash).has(value)};FastSet.prototype.get=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){return buckets.get(hash).get(value)}else{return this.getDefault(value)}};FastSet.prototype["delete"]=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){var bucket=buckets.get(hash);if(bucket["delete"](value)){this.length--;if(bucket.length===0){buckets["delete"](hash)}return true}}return false};FastSet.prototype.clear=function(){this.buckets.clear();this.length=0};FastSet.prototype.add=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(!buckets.has(hash)){buckets.set(hash,new this.Bucket(null,this.contentEquals))}if(!buckets.get(hash).has(value)){buckets.get(hash).add(value);this.length++;return true}return false};FastSet.prototype.reduce=function(callback,basis){var thisp=arguments[2];var buckets=this.buckets;var index=0;return buckets.reduce(function(basis,bucket){return bucket.reduce(function(basis,value){return callback.call(thisp,basis,value,index++,this)},basis,this)},basis,this)};FastSet.prototype.one=function(){if(this.length>0){return this.buckets.one().one()}};FastSet.prototype.iterate=function(){return this.buckets.values().flatten().iterate()};FastSet.prototype.log=function(charmap,logNode,callback,thisp){charmap=charmap||TreeLog.unicodeSharp;logNode=logNode||this.logNode;if(!callback){callback=console.log;thisp=console}callback=callback.bind(thisp);var buckets=this.buckets;var hashes=buckets.keys();hashes.forEach(function(hash,index){var branch;var leader;if(index===hashes.length-1){branch=charmap.fromAbove;leader=" "}else if(index===0){branch=charmap.branchDown;leader=charmap.strafe}else{branch=charmap.fromBoth;leader=charmap.strafe}var bucket=buckets.get(hash);callback.call(thisp,branch+charmap.through+charmap.branchDown+" "+hash);bucket.forEach(function(value,node){var branch,below;if(node===bucket.head.prev){branch=charmap.fromAbove;below=" "}else{branch=charmap.fromBoth;below=charmap.strafe}var written;logNode(node,function(line){if(!written){callback.call(thisp,leader+" "+branch+charmap.through+charmap.through+line);written=true}else{callback.call(thisp,leader+" "+below+"  "+line)}},function(line){callback.call(thisp,leader+" "+charmap.strafe+"  "+line)})})})};FastSet.prototype.logNode=function(node,write){var value=node.value;if(Object(value)===value){JSON.stringify(value,null,4).split("\n").forEach(function(line){write(" "+line)})}else{write(" "+value)}}},{"./dict":35,"./generic-collection":38,"./generic-set":41,"./list":42,"./listen/property-changes":44,"./shim":51,"./tree-log":52}],38:[function(require,module,exports){"use strict";module.exports=GenericCollection;function GenericCollection(){throw new Error("Can't construct. GenericCollection is a mixin.")}GenericCollection.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){values.forEach(this.add,this)}else if(typeof values.length==="number"){for(var i=0;i<values.length;i++){this.add(values[i],i)}}else{Object.keys(values).forEach(function(key){this.add(values[key],key)},this)}}return this};GenericCollection.prototype.deleteEach=function(values,equals){values.forEach(function(value){this["delete"](value,equals)},this);return this};GenericCollection.prototype.forEach=function(callback){var thisp=arguments[1];return this.reduce(function(undefined,value,key,object,depth){callback.call(thisp,value,key,object,depth)},undefined)};GenericCollection.prototype.map=function(callback){var thisp=arguments[1];var result=[];this.reduce(function(undefined,value,key,object,depth){result.push(callback.call(thisp,value,key,object,depth))},undefined);return result};GenericCollection.prototype.enumerate=function(start){if(start==null){start=0}var result=[];this.reduce(function(undefined,value){result.push([start++,value])},undefined);return result};GenericCollection.prototype.group=function(callback,thisp,equals){equals=equals||Object.equals;var groups=[];var keys=[];this.forEach(function(value,key,object){var key=callback.call(thisp,value,key,object);var index=keys.indexOf(key,equals);var group;if(index===-1){group=[];groups.push([key,group]);keys.push(key)}else{group=groups[index][1]}group.push(value)});return groups};GenericCollection.prototype.toArray=function(){return this.map(Function.identity)};GenericCollection.prototype.toObject=function(){var object={};this.reduce(function(undefined,value,key){object[key]=value},undefined);return object};GenericCollection.prototype.filter=function(callback){var thisp=arguments[1];var result=this.constructClone();this.reduce(function(undefined,value,key,object,depth){if(callback.call(thisp,value,key,object,depth)){result.add(value)}},undefined);return result};GenericCollection.prototype.every=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result&&callback.call(thisp,value,key,object,depth)},true)};GenericCollection.prototype.some=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result||callback.call(thisp,value,key,object,depth)},false)};GenericCollection.prototype.all=function(){return this.every(Boolean)};GenericCollection.prototype.any=function(){return this.some(Boolean)};GenericCollection.prototype.min=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)<0?value:result}},undefined)};GenericCollection.prototype.max=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)>0?value:result}},undefined)};GenericCollection.prototype.sum=function(zero){zero=zero===undefined?0:zero;return this.reduce(function(a,b){return a+b},zero)};GenericCollection.prototype.average=function(zero){var sum=zero===undefined?0:zero;var count=zero===undefined?0:zero;this.reduce(function(undefined,value){sum+=value;count+=1},undefined);return sum/count};GenericCollection.prototype.concat=function(){var result=this.constructClone(this);for(var i=0;i<arguments.length;i++){result.addEach(arguments[i])}return result};GenericCollection.prototype.flatten=function(){var self=this;return this.reduce(function(result,array){array.forEach(function(value){this.push(value)},result,self);return result},[])};GenericCollection.prototype.zip=function(){var table=Array.prototype.slice.call(arguments);table.unshift(this);return Array.unzip(table)};GenericCollection.prototype.join=function(delimiter){return this.reduce(function(result,string){return result+delimiter+string})};GenericCollection.prototype.sorted=function(compare,by,order){compare=compare||this.contentCompare||Object.compare;if(compare.by){by=compare.by;compare=compare.compare||this.contentCompare||Object.compare}else{by=by||Function.identity}if(order===undefined)order=1;return this.map(function(item){return{by:by(item),value:item}}).sort(function(a,b){return compare(a.by,b.by)*order}).map(function(pair){return pair.value})};GenericCollection.prototype.reversed=function(){return this.constructClone(this).reverse()};GenericCollection.prototype.clone=function(depth,memo){if(depth===undefined){depth=Infinity}else if(depth===0){return this}var clone=this.constructClone();this.forEach(function(value,key){clone.add(Object.clone(value,depth-1,memo),key)},this);return clone};GenericCollection.prototype.only=function(){if(this.length===1){return this.one()}};GenericCollection.prototype.iterator=function(){return this.iterate.apply(this,arguments)};require("./shim-array")},{"./shim-array":47}],39:[function(require,module,exports){"use strict";var Object=require("./shim-object");var MapChanges=require("./listen/map-changes");var PropertyChanges=require("./listen/property-changes");module.exports=GenericMap;function GenericMap(){throw new Error("Can't construct. GenericMap is a mixin.")}Object.addEach(GenericMap.prototype,MapChanges.prototype);Object.addEach(GenericMap.prototype,PropertyChanges.prototype);GenericMap.prototype.isMap=true;GenericMap.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){if(values.isMap===true){values.forEach(function(value,key){this.set(key,value)},this)}else{values.forEach(function(pair){this.set(pair[0],pair[1])},this)}}else{Object.keys(values).forEach(function(key){this.set(key,values[key])},this)}}return this};GenericMap.prototype.get=function(key,defaultValue){var item=this.store.get(new this.Item(key));if(item){return item.value}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};GenericMap.prototype.set=function(key,value){var item=new this.Item(key,value);var found=this.store.get(item);var grew=false;if(found){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,found.value)}found.value=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}if(this.store.add(item)){this.length++;grew=true}if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}return grew};GenericMap.prototype.add=function(value,key){return this.set(key,value)};GenericMap.prototype.has=function(key){return this.store.has(new this.Item(key))};GenericMap.prototype["delete"]=function(key){var item=new this.Item(key);if(this.store.has(item)){var from=this.store.get(item).value;if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,from)}this.store["delete"](item);this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};GenericMap.prototype.clear=function(){var keys;if(this.dispatchesMapChanges){this.forEach(function(value,key){this.dispatchBeforeMapChange(key,value)},this);keys=this.keys()}this.store.clear();this.length=0;if(this.dispatchesMapChanges){keys.forEach(function(key){this.dispatchMapChange(key)},this)}};GenericMap.prototype.reduce=function(callback,basis,thisp){return this.store.reduce(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.reduceRight=function(callback,basis,thisp){return this.store.reduceRight(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.keys=function(){return this.map(function(value,key){return key})};GenericMap.prototype.values=function(){return this.map(Function.identity)};GenericMap.prototype.entries=function(){return this.map(function(value,key){return[key,value]})};GenericMap.prototype.items=function(){return this.entries()};GenericMap.prototype.equals=function(that,equals){equals=equals||Object.equals;if(this===that){return true}else if(Object.can(that,"every")){return that.length===this.length&&that.every(function(value,key){return equals(this.get(key),value)},this)}else{var keys=Object.keys(that);return keys.length===this.length&&Object.keys(that).every(function(key){return equals(this.get(key),that[key])},this)}};GenericMap.prototype.Item=Item;function Item(key,value){this.key=key;this.value=value}Item.prototype.equals=function(that){return Object.equals(this.key,that.key)&&Object.equals(this.value,that.value)};Item.prototype.compare=function(that){return Object.compare(this.key,that.key)}},{"./listen/map-changes":43,"./listen/property-changes":44,"./shim-object":49}],40:[function(require,module,exports){var Object=require("./shim-object");module.exports=GenericOrder;function GenericOrder(){throw new Error("Can't construct. GenericOrder is a mixin.")}GenericOrder.prototype.equals=function(that,equals){equals=equals||this.contentEquals||Object.equals;if(this===that){return true}if(!that){return false}var self=this;return this.length===that.length&&this.zip(that).every(function(pair){return equals(pair[0],pair[1])})};GenericOrder.prototype.compare=function(that,compare){compare=compare||this.contentCompare||Object.compare;if(this===that){return 0}if(!that){return 1}var length=Math.min(this.length,that.length);var comparison=this.zip(that).reduce(function(comparison,pair,index){if(comparison===0){if(index>=length){return comparison}else{return compare(pair[0],pair[1])}}else{return comparison}},0);if(comparison===0){return this.length-that.length}return comparison}},{"./shim-object":49}],41:[function(require,module,exports){module.exports=GenericSet;function GenericSet(){throw new Error("Can't construct. GenericSet is a mixin.")}GenericSet.prototype.union=function(that){var union=this.constructClone(this);union.addEach(that);return union};GenericSet.prototype.intersection=function(that){return this.constructClone(this.filter(function(value){return that.has(value)}))};GenericSet.prototype.difference=function(that){var union=this.constructClone(this);union.deleteEach(that);return union};GenericSet.prototype.symmetricDifference=function(that){var union=this.union(that);var intersection=this.intersection(that);return union.difference(intersection)
};GenericSet.prototype.equals=function(that,equals){var self=this;return Object.can(that,"reduce")&&this.length===that.length&&that.reduce(function(equal,value){return equal&&self.has(value,equals)},true)};GenericSet.prototype.contains=function(value){return this.has(value)};GenericSet.prototype.remove=function(value){return this["delete"](value)};GenericSet.prototype.toggle=function(value){if(this.has(value)){this["delete"](value)}else{this.add(value)}}},{}],42:[function(require,module,exports){"use strict";module.exports=List;var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var PropertyChanges=require("./listen/property-changes");var RangeChanges=require("./listen/range-changes");function List(values,equals,getDefault){if(!(this instanceof List)){return new List(values,equals,getDefault)}var head=this.head=new this.Node;head.next=head;head.prev=head;this.contentEquals=equals||Object.equals;this.getDefault=getDefault||Function.noop;this.length=0;this.addEach(values)}List.List=List;Object.addEach(List.prototype,GenericCollection.prototype);Object.addEach(List.prototype,GenericOrder.prototype);Object.addEach(List.prototype,PropertyChanges.prototype);Object.addEach(List.prototype,RangeChanges.prototype);List.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.getDefault)};List.prototype.find=function(value,equals){equals=equals||this.contentEquals;var head=this.head;var at=head.next;while(at!==head){if(equals(at.value,value)){return at}at=at.next}};List.prototype.findLast=function(value,equals){equals=equals||this.contentEquals;var head=this.head;var at=head.prev;while(at!==head){if(equals(at.value,value)){return at}at=at.prev}};List.prototype.has=function(value,equals){return!!this.find(value,equals)};List.prototype.get=function(value,equals){var found=this.find(value,equals);if(found){return found.value}return this.getDefault(value)};List.prototype["delete"]=function(value,equals){var found=this.findLast(value,equals);if(found){if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,found.index)}found["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(found.next,found.index);this.dispatchRangeChange(plus,minus,found.index)}return true}return false};List.prototype.clear=function(){var plus,minus;if(this.dispatchesRangeChanges){minus=this.toArray();plus=[];this.dispatchBeforeRangeChange(plus,minus,0)}this.head.next=this.head.prev=this.head;this.length=0;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}};List.prototype.add=function(value){var node=new this.Node(value);if(this.dispatchesRangeChanges){node.index=this.length;this.dispatchBeforeRangeChange([value],[],node.index)}this.head.addBefore(node);this.length++;if(this.dispatchesRangeChanges){this.dispatchRangeChange([value],[],node.index)}return true};List.prototype.push=function(){var head=this.head;if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];var index=this.length;this.dispatchBeforeRangeChange(plus,minus,index);var start=this.head.prev}for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);head.addBefore(node)}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(start.next,start.index===undefined?0:start.index+1);this.dispatchRangeChange(plus,minus,index)}};List.prototype.unshift=function(){if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);at.addAfter(node);at=node}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}};List.prototype.pop=function(){var value;var head=this.head;if(head.prev!==head){value=head.prev.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];var index=this.length-1;this.dispatchBeforeRangeChange(plus,minus,index)}head.prev["delete"]();this.length--;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,index)}}return value};List.prototype.shift=function(){var value;var head=this.head;if(head.prev!==head){value=head.next.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,0)}head.next["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}}return value};List.prototype.peek=function(){if(this.head!==this.head.next){return this.head.next.value}};List.prototype.poke=function(value){if(this.head!==this.head.next){this.head.next.value=value}else{this.push(value)}};List.prototype.one=function(){return this.peek()};List.prototype.scan=function(at,fallback){var head=this.head;if(typeof at==="number"){var count=at;if(count>=0){at=head.next;while(count){count--;at=at.next;if(at==head){break}}}else{at=head;while(count<0){count++;at=at.prev;if(at==head){break}}}return at}else{return at||fallback}};List.prototype.slice=function(at,end){var sliced=[];var head=this.head;at=this.scan(at,head.next);end=this.scan(end,head);while(at!==end&&at!==head){sliced.push(at.value);at=at.next}return sliced};List.prototype.splice=function(at,length){return this.swap(at,length,Array.prototype.slice.call(arguments,2))};List.prototype.swap=function(start,length,plus){var initial=start;start=this.scan(start,this.head);if(length==null){length=Infinity}plus=Array.from(plus);var minus=[];var at=start;while(length--&&length>=0&&at!==this.head){minus.push(at.value);at=at.next}var index,startNode;if(this.dispatchesRangeChanges){if(start===this.head){index=this.length}else if(start.prev===this.head){index=0}else{index=start.index}startNode=start.prev;this.dispatchBeforeRangeChange(plus,minus,index)}var at=start;for(var i=0,at=start;i<minus.length;i++,at=at.next){at["delete"]()}if(initial==null&&at===this.head){at=this.head.next}for(var i=0;i<plus.length;i++){var node=new this.Node(plus[i]);at.addBefore(node)}this.length+=plus.length-minus.length;if(this.dispatchesRangeChanges){if(start===this.head){this.updateIndexes(this.head.next,0)}else{this.updateIndexes(startNode.next,startNode.index+1)}this.dispatchRangeChange(plus,minus,index)}return minus};List.prototype.reverse=function(){if(this.dispatchesRangeChanges){var minus=this.toArray();var plus=minus.reversed();this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;do{var temp=at.next;at.next=at.prev;at.prev=temp;at=at.next}while(at!==this.head);if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}return this};List.prototype.sort=function(){this.swap(0,this.length,this.sorted())};List.prototype.reduce=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.next;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.next}return basis};List.prototype.reduceRight=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.prev;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.prev}return basis};List.prototype.updateIndexes=function(node,index){while(node!==this.head){node.index=index++;node=node.next}};List.prototype.makeObservable=function(){this.head.index=-1;this.updateIndexes(this.head.next,0);this.dispatchesRangeChanges=true};List.prototype.iterate=function(){return new ListIterator(this.head)};function ListIterator(head){this.head=head;this.at=head.next}ListIterator.prototype.next=function(){if(this.at===this.head){throw StopIteration}else{var value=this.at.value;this.at=this.at.next;return value}};List.prototype.Node=Node;function Node(value){this.value=value;this.prev=null;this.next=null}Node.prototype["delete"]=function(){this.prev.next=this.next;this.next.prev=this.prev};Node.prototype.addBefore=function(node){var prev=this.prev;this.prev=node;node.prev=prev;prev.next=node;node.next=this};Node.prototype.addAfter=function(node){var next=this.next;this.next=node;node.next=next;next.prev=node;node.prev=this}},{"./generic-collection":38,"./generic-order":40,"./listen/property-changes":44,"./listen/range-changes":45,"./shim":51}],43:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var List=require("../list");module.exports=MapChanges;function MapChanges(){throw new Error("Can't construct. MapChanges is a mixin.")}var object_owns=Object.prototype.hasOwnProperty;var mapChangeDescriptors=new WeakMap;MapChanges.prototype.getAllMapChangeDescriptors=function(){var Dict=require("../dict");if(!mapChangeDescriptors.has(this)){mapChangeDescriptors.set(this,Dict())}return mapChangeDescriptors.get(this)};MapChanges.prototype.getMapChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllMapChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{willChangeListeners:new List,changeListeners:new List})}return tokenChangeDescriptors.get(token)};MapChanges.prototype.addMapChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesMapChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelMapChangeListener(){if(!self){return}self.removeMapChangeListener(listener,token,beforeChange);self=null}};MapChanges.prototype.removeMapChangeListener=function(listener,token,beforeChange){var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var node=listeners.findLast(listener);if(!node){throw new Error("Can't remove listener: does not exist.")}node["delete"]()};MapChanges.prototype.dispatchMapChange=function(key,value,beforeChange){var descriptors=this.getAllMapChangeDescriptors();var changeName="Map"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.forEach(function(listener){if(listener[tokenName]){listener[tokenName](value,key,this)}else if(listener.call){listener.call(listener,value,key,this)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};MapChanges.prototype.addBeforeMapChangeListener=function(listener,token){return this.addMapChangeListener(listener,token,true)};MapChanges.prototype.removeBeforeMapChangeListener=function(listener,token){return this.removeMapChangeListener(listener,token,true)};MapChanges.prototype.dispatchBeforeMapChange=function(key,value){return this.dispatchMapChange(key,value,true)}},{"../dict":35,"../list":42,"weak-map":46}],44:[function(require,module,exports){require("../shim");var WeakMap=require("weak-map");var object_owns=Object.prototype.hasOwnProperty;var propertyChangeDescriptors=new WeakMap;var overriddenObjectDescriptors=new WeakMap;module.exports=PropertyChanges;function PropertyChanges(){throw new Error("This is an abstract interface. Mix it. Don't construct it")}PropertyChanges.debug=true;PropertyChanges.prototype.getOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){propertyChangeDescriptors.set(this,{})}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){objectPropertyChangeDescriptors[key]={willChangeListeners:[],changeListeners:[]}}return objectPropertyChangeDescriptors[key]};PropertyChanges.prototype.hasOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){return false}if(!key){return true}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){return false}return true};PropertyChanges.prototype.addOwnPropertyChangeListener=function(key,listener,beforeChange){if(this.makeObservable&&!this.isObservable){this.makeObservable()}var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}PropertyChanges.makePropertyObservable(this,key);listeners.push(listener);var self=this;return function cancelOwnPropertyChangeListener(){PropertyChanges.removeOwnPropertyChangeListener(self,key,listeners,beforeChange);self=null}};PropertyChanges.prototype.addBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.addOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.removeOwnPropertyChangeListener=function(key,listener,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove listener: does not exist.")}listeners.splice(index,1);if(descriptor.changeListeners.length+descriptor.willChangeListeners.length===0){PropertyChanges.makePropertyUnobservable(this,key)}};PropertyChanges.prototype.removeBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.removeOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.dispatchOwnPropertyChange=function(key,value,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);if(descriptor.isActive){return}descriptor.isActive=true;var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var changeName=(beforeChange?"Will":"")+"Change";var genericHandlerName="handleProperty"+changeName;var propertyName=String(key);propertyName=propertyName&&propertyName[0].toUpperCase()+propertyName.slice(1);var specificHandlerName="handle"+propertyName+changeName;try{listeners.forEach(function(listener){var thisp=listener;listener=listener[specificHandlerName]||listener[genericHandlerName]||listener;if(!listener.call){throw new Error("No event listener for "+specificHandlerName+" or "+genericHandlerName+" or call on "+listener)}listener.call(thisp,value,key,this)},this)}finally{descriptor.isActive=false}};PropertyChanges.prototype.dispatchBeforeOwnPropertyChange=function(key,listener){return PropertyChanges.dispatchOwnPropertyChange(this,key,listener,true)};PropertyChanges.prototype.makePropertyObservable=function(key){if(Array.isArray(this)){return}if(!Object.isExtensible(this,key)){throw new Error("Can't make property "+JSON.stringify(key)+" observable on "+this+" because object is not extensible")}var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}state[key]=this[key];if(!overriddenObjectDescriptors.has(this)){overriddenPropertyDescriptors={};overriddenObjectDescriptors.set(this,overriddenPropertyDescriptors)}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(object_owns.call(overriddenPropertyDescriptors,key)){return}var overriddenDescriptor;var attached=this;var formerDescriptor=Object.getOwnPropertyDescriptor(attached,key);do{overriddenDescriptor=Object.getOwnPropertyDescriptor(attached,key);if(overriddenDescriptor){break}attached=Object.getPrototypeOf(attached)}while(attached);overriddenDescriptor=overriddenDescriptor||{value:undefined,enumerable:true,writable:true,configurable:true};if(!overriddenDescriptor.configurable){throw new Error("Can't observe non-configurable properties")}overriddenPropertyDescriptors[key]=overriddenDescriptor;if(!overriddenDescriptor.writable&&!overriddenDescriptor.set){return}var propertyListener;if("value"in overriddenDescriptor){propertyListener={get:function(){return overriddenDescriptor.value},set:function(value){if(value===overriddenDescriptor.value){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,overriddenDescriptor.value);overriddenDescriptor.value=value;state[key]=value;PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}else{propertyListener={get:function(){if(overriddenDescriptor.get){return overriddenDescriptor.get.apply(this,arguments)}},set:function(value){var formerValue;if(overriddenDescriptor.get){formerValue=overriddenDescriptor.get.apply(this,arguments)}if(overriddenDescriptor.set){overriddenDescriptor.set.apply(this,arguments)}if(overriddenDescriptor.get){value=overriddenDescriptor.get.apply(this,arguments);state[key]=value}if(value===formerValue){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,formerValue);PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}Object.defineProperty(this,key,propertyListener)};PropertyChanges.prototype.makePropertyUnobservable=function(key){if(Array.isArray(this)){return}if(!overriddenObjectDescriptors.has(this)){throw new Error("Can't uninstall observer on property")}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(!overriddenPropertyDescriptors[key]){throw new Error("Can't uninstall observer on property")}var overriddenDescriptor=overriddenPropertyDescriptors[key];delete overriddenPropertyDescriptors[key];var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}delete state[key];Object.defineProperty(this,key,overriddenDescriptor)};PropertyChanges.getOwnPropertyChangeDescriptor=function(object,key){if(object.getOwnPropertyChangeDescriptor){return object.getOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.getOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.hasOwnPropertyChangeDescriptor=function(object,key){if(object.hasOwnPropertyChangeDescriptor){return object.hasOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.hasOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.addOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.addOwnPropertyChangeListener){return object.addOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.addOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.removeOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.removeOwnPropertyChangeListener){return object.removeOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.removeOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.dispatchOwnPropertyChange=function(object,key,value,beforeChange){if(!Object.isObject(object)){}else if(object.dispatchOwnPropertyChange){return object.dispatchOwnPropertyChange(key,value,beforeChange)}else{return PropertyChanges.prototype.dispatchOwnPropertyChange.call(object,key,value,beforeChange)}};PropertyChanges.addBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.addOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.removeBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.removeOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.dispatchBeforeOwnPropertyChange=function(object,key,value){return PropertyChanges.dispatchOwnPropertyChange(object,key,value,true)};PropertyChanges.makePropertyObservable=function(object,key){if(object.makePropertyObservable){return object.makePropertyObservable(key)}else{return PropertyChanges.prototype.makePropertyObservable.call(object,key)}};PropertyChanges.makePropertyUnobservable=function(object,key){if(object.makePropertyUnobservable){return object.makePropertyUnobservable(key)}else{return PropertyChanges.prototype.makePropertyUnobservable.call(object,key)}}},{"../shim":51,"weak-map":46}],45:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var Dict=require("../dict");var rangeChangeDescriptors=new WeakMap;module.exports=RangeChanges;function RangeChanges(){throw new Error("Can't construct. RangeChanges is a mixin.")}RangeChanges.prototype.getAllRangeChangeDescriptors=function(){if(!rangeChangeDescriptors.has(this)){rangeChangeDescriptors.set(this,Dict())}return rangeChangeDescriptors.get(this)};RangeChanges.prototype.getRangeChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllRangeChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{isActive:false,changeListeners:[],willChangeListeners:[]})}return tokenChangeDescriptors.get(token)};RangeChanges.prototype.addRangeChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesRangeChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelRangeChangeListener(){if(!self){return}self.removeRangeChangeListener(listener,token,beforeChange);self=null}};RangeChanges.prototype.removeRangeChangeListener=function(listener,token,beforeChange){var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove listener: does not exist.")}listeners.splice(index,1)};RangeChanges.prototype.dispatchRangeChange=function(plus,minus,index,beforeChange){var descriptors=this.getAllRangeChangeDescriptors();var changeName="Range"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.forEach(function(listener){if(listener[tokenName]){listener[tokenName](plus,minus,index,this,beforeChange)}else if(listener.call){listener.call(this,plus,minus,index,this,beforeChange)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};RangeChanges.prototype.addBeforeRangeChangeListener=function(listener,token){return this.addRangeChangeListener(listener,token,true)};RangeChanges.prototype.removeBeforeRangeChangeListener=function(listener,token){return this.removeRangeChangeListener(listener,token,true)};RangeChanges.prototype.dispatchBeforeRangeChange=function(plus,minus,index){return this.dispatchRangeChange(plus,minus,index,true)}},{"../dict":35,"weak-map":46}],46:[function(require,module,exports){(function WeakMapModule(){"use strict";if(typeof ses!=="undefined"&&ses.ok&&!ses.ok()){return}function weakMapPermitHostObjects(map){if(map.permitHostObjects___){map.permitHostObjects___(weakMapPermitHostObjects)}}if(typeof ses!=="undefined"){ses.weakMapPermitHostObjects=weakMapPermitHostObjects}if(typeof WeakMap==="function"){var HostWeakMap=WeakMap;if(typeof navigator!=="undefined"&&/Firefox/.test(navigator.userAgent)){}else{module.exports=WeakMap;return}}var hop=Object.prototype.hasOwnProperty;var gopn=Object.getOwnPropertyNames;var defProp=Object.defineProperty;var isExtensible=Object.isExtensible;var HIDDEN_NAME_PREFIX="weakmap:";var HIDDEN_NAME=HIDDEN_NAME_PREFIX+"ident:"+Math.random()+"___";if(typeof crypto!=="undefined"&&typeof crypto.getRandomValues==="function"&&typeof ArrayBuffer==="function"&&typeof Uint8Array==="function"){var ab=new ArrayBuffer(25);var u8s=new Uint8Array(ab);crypto.getRandomValues(u8s);HIDDEN_NAME=HIDDEN_NAME_PREFIX+"rand:"+Array.prototype.map.call(u8s,function(u8){return(u8%36).toString(36)}).join("")+"___"}function isNotHiddenName(name){return!(name.substr(0,HIDDEN_NAME_PREFIX.length)==HIDDEN_NAME_PREFIX&&name.substr(name.length-3)==="___")}defProp(Object,"getOwnPropertyNames",{value:function fakeGetOwnPropertyNames(obj){return gopn(obj).filter(isNotHiddenName)}});if("getPropertyNames"in Object){var originalGetPropertyNames=Object.getPropertyNames;defProp(Object,"getPropertyNames",{value:function fakeGetPropertyNames(obj){return originalGetPropertyNames(obj).filter(isNotHiddenName)}})}function getHiddenRecord(key){if(key!==Object(key)){throw new TypeError("Not an object: "+key)}var hiddenRecord=key[HIDDEN_NAME];if(hiddenRecord&&hiddenRecord.key===key){return hiddenRecord}if(!isExtensible(key)){return void 0}var gets=[];var vals=[];hiddenRecord={key:key,gets:gets,vals:vals};defProp(key,HIDDEN_NAME,{value:hiddenRecord,writable:false,enumerable:false,configurable:false});return hiddenRecord}(function(){var oldFreeze=Object.freeze;defProp(Object,"freeze",{value:function identifyingFreeze(obj){getHiddenRecord(obj);return oldFreeze(obj)}});var oldSeal=Object.seal;defProp(Object,"seal",{value:function identifyingSeal(obj){getHiddenRecord(obj);return oldSeal(obj)}});var oldPreventExtensions=Object.preventExtensions;defProp(Object,"preventExtensions",{value:function identifyingPreventExtensions(obj){getHiddenRecord(obj);return oldPreventExtensions(obj)}})})();function constFunc(func){func.prototype=null;return Object.freeze(func)}var OurWeakMap=function(){var keys=[];var vals=[];function get___(key,opt_default){var hr=getHiddenRecord(key);var i,vs;if(hr){i=hr.gets.indexOf(get___);vs=hr.vals}else{i=keys.indexOf(key);vs=vals}return i>=0?vs[i]:opt_default}function has___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___)}else{i=keys.indexOf(key)}return i>=0}function set___(key,value){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.vals[i]=value}else{hr.gets.push(get___);hr.vals.push(value)}}else{i=keys.indexOf(key);if(i>=0){vals[i]=value}else{keys.push(key);vals.push(value)}}}function delete___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.gets.splice(i,1);hr.vals.splice(i,1)}}else{i=keys.indexOf(key);if(i>=0){keys.splice(i,1);vals.splice(i,1)}}return true}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(get___)},has___:{value:constFunc(has___)},set___:{value:constFunc(set___)},delete___:{value:constFunc(delete___)}})};OurWeakMap.prototype=Object.create(Object.prototype,{get:{value:function get(key,opt_default){return this.get___(key,opt_default)},writable:true,configurable:true},has:{value:function has(key){return this.has___(key)},writable:true,configurable:true},set:{value:function set(key,value){this.set___(key,value)},writable:true,configurable:true},"delete":{value:function remove(key){return this.delete___(key)},writable:true,configurable:true}});if(typeof HostWeakMap==="function"){(function(){function DoubleWeakMap(){var hmap=new HostWeakMap;var omap=undefined;var enableSwitching=false;function dget(key,opt_default){if(omap){return hmap.has(key)?hmap.get(key):omap.get___(key,opt_default)}else{return hmap.get(key,opt_default)}}function dhas(key){return hmap.has(key)||(omap?omap.has___(key):false)}function dset(key,value){if(enableSwitching){try{hmap.set(key,value)}catch(e){if(!omap){omap=new OurWeakMap}omap.set___(key,value)}}else{hmap.set(key,value)}}function ddelete(key){hmap["delete"](key);if(omap){omap.delete___(key)}}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(dget)},has___:{value:constFunc(dhas)},set___:{value:constFunc(dset)},delete___:{value:constFunc(ddelete)},permitHostObjects___:{value:constFunc(function(token){if(token===weakMapPermitHostObjects){enableSwitching=true}else{throw new Error("bogus call to permitHostObjects___")}})}})}DoubleWeakMap.prototype=OurWeakMap.prototype;module.exports=DoubleWeakMap;Object.defineProperty(WeakMap.prototype,"constructor",{value:WeakMap,enumerable:false,configurable:true,writable:true})})()}else{if(typeof Proxy!=="undefined"){Proxy=undefined}module.exports=OurWeakMap}})()},{}],47:[function(require,module,exports){"use strict";var Function=require("./shim-function");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var WeakMap=require("weak-map");module.exports=Array;Array.empty=[];if(Object.freeze){Object.freeze(Array.empty)}Array.from=function(values){var array=[];array.addEach(values);return array};Array.unzip=function(table){var transpose=[];var length=Infinity;for(var i=0;i<table.length;i++){var row=table[i];table[i]=row.toArray();if(row.length<length){length=row.length}}for(var i=0;i<table.length;i++){var row=table[i];for(var j=0;j<row.length;j++){if(j<length&&j in row){transpose[j]=transpose[j]||[];transpose[j][i]=row[j]}}}return transpose};function define(key,value){Object.defineProperty(Array.prototype,key,{value:value,writable:true,configurable:true,enumerable:false})}define("addEach",GenericCollection.prototype.addEach);define("deleteEach",GenericCollection.prototype.deleteEach);define("toArray",GenericCollection.prototype.toArray);define("toObject",GenericCollection.prototype.toObject);define("all",GenericCollection.prototype.all);define("any",GenericCollection.prototype.any);define("min",GenericCollection.prototype.min);define("max",GenericCollection.prototype.max);define("sum",GenericCollection.prototype.sum);define("average",GenericCollection.prototype.average);define("only",GenericCollection.prototype.only);define("flatten",GenericCollection.prototype.flatten);define("zip",GenericCollection.prototype.zip);define("enumerate",GenericCollection.prototype.enumerate);define("group",GenericCollection.prototype.group);define("sorted",GenericCollection.prototype.sorted);define("reversed",GenericCollection.prototype.reversed);define("constructClone",function(values){var clone=new this.constructor;clone.addEach(values);return clone});define("has",function(value,equals){return this.find(value,equals)!==-1});define("get",function(index,defaultValue){if(+index!==index)throw new Error("Indicies must be numbers");if(!index in this){return defaultValue}else{return this[index]}});define("set",function(index,value){this.splice(index,1,value);return true});define("add",function(value){this.push(value);return true});define("delete",function(value,equals){var index=this.find(value,equals);if(index!==-1){this.splice(index,1);return true}return false});define("find",function(value,equals){equals=equals||this.contentEquals||Object.equals;for(var index=0;index<this.length;index++){if(index in this&&equals(this[index],value)){return index}}return-1});define("findLast",function(value,equals){equals=equals||this.contentEquals||Object.equals;var index=this.length;do{index--;if(index in this&&equals(this[index],value)){return index}}while(index>0);return-1});define("swap",function(index,length,plus){var args=Array.prototype.slice.call(arguments,0,2);if(plus){if(!Array.isArray(plus)){plus=Array.prototype.slice.call(plus)}args.push.apply(args,plus)}return this.splice.apply(this,args)});define("one",function(){for(var i in this){if(Object.owns(this,i)){return this[i]
}}});define("clear",function(){this.length=0;return this});define("compare",function(that,compare){compare=compare||Object.compare;var i;var length;var lhs;var rhs;var relative;if(this===that){return 0}if(!that||!Array.isArray(that)){return GenericOrder.prototype.compare.call(this,that,compare)}length=Math.min(this.length,that.length);for(i=0;i<length;i++){if(i in this){if(!(i in that)){return-1}else{lhs=this[i];rhs=that[i];relative=compare(lhs,rhs);if(relative){return relative}}}else if(i in that){return 1}}return this.length-that.length});define("equals",function(that,equals){equals=equals||Object.equals;var i=0;var length=this.length;var left;var right;if(this===that){return true}if(!that||!Array.isArray(that)){return GenericOrder.prototype.equals.call(this,that)}if(length!==that.length){return false}else{for(;i<length;++i){if(i in this){if(!(i in that)){return false}left=this[i];right=that[i];if(!equals(left,right)){return false}}else{if(i in that){return false}}}}return true});define("clone",function(depth,memo){if(depth===undefined){depth=Infinity}else if(depth===0){return this}memo=memo||new WeakMap;var clone=[];for(var i in this){if(Object.owns(this,i)){clone[i]=Object.clone(this[i],depth-1,memo)}}return clone});define("iterate",function(start,end){return new ArrayIterator(this,start,end)});define("Iterator",ArrayIterator);function ArrayIterator(array,start,end){this.array=array;this.start=start==null?0:start;this.end=end}ArrayIterator.prototype.next=function(){if(this.start===(this.end==null?this.array.length:this.end)){throw StopIteration}else{return this.array[this.start++]}}},{"./generic-collection":38,"./generic-order":40,"./shim-function":48,"weak-map":46}],48:[function(require,module,exports){module.exports=Function;Function.noop=function(){};Function.identity=function(value){return value};Function.by=function(by,compare){compare=compare||Object.compare;by=by||Function.identity;var compareBy=function(a,b){return compare(by(a),by(b))};compareBy.compare=compare;compareBy.by=by;return compareBy};Function.get=function(key){return function(object){return Object.get(object,key)}}},{}],49:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");module.exports=Object;Object.empty=Object.freeze(Object.create(null));Object.isObject=function(object){return Object(object)===object};Object.getValueOf=function(value){if(Object.can(value,"valueOf")){value=value.valueOf()}return value};var hashMap=new WeakMap;Object.hash=function(object){if(Object.can(object,"hash")){return""+object.hash()}else if(Object(object)===object){if(!hashMap.has(object)){hashMap.set(object,Math.random().toString(36).slice(2))}return hashMap.get(object)}else{return""+object}};var owns=Object.prototype.hasOwnProperty;Object.owns=function(object,key){return owns.call(object,key)};Object.can=function(object,name){return object!=null&&typeof object[name]==="function"&&!owns.call(object,name)};Object.has=function(object,key){if(typeof object!=="object"){throw new Error("Object.has can't accept non-object: "+typeof object)}if(Object.can(object,"has")){return object.has(key)}else if(typeof key==="string"){return key in object&&object[key]!==Object.prototype[key]}else{throw new Error("Key must be a string for Object.has on plain objects")}};Object.get=function(object,key,value){if(typeof object!=="object"){throw new Error("Object.get can't accept non-object: "+typeof object)}if(Object.can(object,"get")){return object.get(key,value)}else if(Object.has(object,key)){return object[key]}else{return value}};Object.set=function(object,key,value){if(Object.can(object,"set")){object.set(key,value)}else{object[key]=value}};Object.addEach=function(target,source){if(!source){}else if(Object.can(source,"forEach")){if(typeof source.keys==="function"){source.forEach(function(value,key){target[key]=value})}else{source.forEach(function(pair){target[pair[0]]=pair[1]})}}else{Object.keys(source).forEach(function(key){target[key]=source[key]})}return target};Object.forEach=function(object,callback,thisp){Object.keys(object).forEach(function(key){callback.call(thisp,object[key],key,object)})};Object.map=function(object,callback,thisp){return Object.keys(object).map(function(key){return callback.call(thisp,object[key],key,object)})};Object.values=function(object){return Object.map(object,Function.identity)};Object.concat=function(){var object={};for(var i=0;i<arguments.length;i++){Object.addEach(object,arguments[i])}return object};Object.from=Object.concat;Object.is=function(x,y){if(x===y){return x!==0||1/x===1/y}return x!==x&&y!==y};Object.equals=function(a,b,equals){equals=equals||Object.equals;a=Object.getValueOf(a);b=Object.getValueOf(b);if(a===b)return a!==0||1/a===1/b;if(a===null||b===null)return a===b;if(Object.can(a,"equals"))return a.equals(b,equals);if(Object.can(b,"equals"))return b.equals(a,equals);if(typeof a==="object"&&typeof b==="object"){var aPrototype=Object.getPrototypeOf(a);var bPrototype=Object.getPrototypeOf(b);if(aPrototype===bPrototype&&(aPrototype===Object.prototype||aPrototype===null)){for(var key in a){if(!equals(a[key],b[key])){return false}}for(var key in b){if(!equals(a[key],b[key])){return false}}return true}}return a!==a&&b!==b};Object.compare=function(a,b){a=Object.getValueOf(a);b=Object.getValueOf(b);var aType=typeof a;var bType=typeof b;if(a===b)return 0;if(aType!==bType)return 0;if(aType==="number")return a-b;if(aType==="string")return a<b?-1:1;if(Object.can(a,"compare"))return a.compare(b);if(Object.can(b,"compare"))return-b.compare(a);return 0};Object.clone=function(value,depth,memo){value=Object.getValueOf(value);memo=memo||new WeakMap;if(depth===undefined){depth=Infinity}else if(depth===0){return value}if(Object.isObject(value)){if(!memo.has(value)){if(Object.can(value,"clone")){memo.set(value,value.clone(depth,memo))}else{var prototype=Object.getPrototypeOf(value);if(prototype===null||prototype===Object.prototype){var clone=Object.create(prototype);memo.set(value,clone);for(var key in value){clone[key]=Object.clone(value[key],depth-1,memo)}}else{throw new Error("Can't clone "+value)}}}return memo.get(value)}return value};Object.clear=function(object){if(Object.can(object,"clear")){object.clear()}else{var keys=Object.keys(object),i=keys.length;while(i){i--;delete object[keys[i]]}}return object}},{"weak-map":46}],50:[function(require,module,exports){if(!RegExp.escape){var special=/[-[\]{}()*+?.\\^$|,#\s]/g;RegExp.escape=function(string){return string.replace(special,"\\$&")}}},{}],51:[function(require,module,exports){var Array=require("./shim-array");var Object=require("./shim-object");var Function=require("./shim-function");var RegExp=require("./shim-regexp")},{"./shim-array":47,"./shim-function":48,"./shim-object":49,"./shim-regexp":50}],52:[function(require,module,exports){"use strict";module.exports=TreeLog;function TreeLog(){}TreeLog.ascii={intersection:"+",through:"-",branchUp:"+",branchDown:"+",fromBelow:".",fromAbove:"'",fromBoth:"+",strafe:"|"};TreeLog.unicodeRound={intersection:"╋",through:"━",branchUp:"┻",branchDown:"┳",fromBelow:"╭",fromAbove:"╰",fromBoth:"┣",strafe:"┃"};TreeLog.unicodeSharp={intersection:"╋",through:"━",branchUp:"┻",branchDown:"┳",fromBelow:"┏",fromAbove:"┗",fromBoth:"┣",strafe:"┃"}},{}],53:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var rng;if(global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!rng){var _rnds=new Array(16);rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}module.exports=rng},{}],54:[function(require,module,exports){var Buffer=require("__browserify_Buffer").Buffer;var _rng=require("./rng");var BufferClass=typeof Buffer=="function"?Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;module.exports=uuid},{"./rng":53,__browserify_Buffer:10}],55:[function(require,module,exports){exports.increment=function(o,nodeId){if(o.clock){o.clock[nodeId]=typeof o.clock[nodeId]=="undefined"?1:o.clock[nodeId]+1}else{o[nodeId]=typeof o[nodeId]=="undefined"?1:o[nodeId]+1}return o};function allKeys(a,b){var last=null;return Object.keys(a).concat(Object.keys(b)).sort().filter(function(item){var isDuplicate=item==last;last=item;return!isDuplicate})}exports.ascSort=exports.compare=function(a,b){var isGreater=false,isLess=false;if(a.clock)a=a.clock;if(b.clock)b=b.clock;allKeys(a,b).forEach(function(key){var diff=(a[key]||0)-(b[key]||0);if(diff>0)isGreater=true;if(diff<0)isLess=true});if(isGreater&&isLess)return 0;if(isLess)return-1;if(isGreater)return 1;return 0};exports.descSort=function(a,b){return 0-exports.ascSort(a,b)};exports.isConcurrent=function(a,b){return!!(exports.compare(a,b)==0)};exports.isIdentical=function(a,b){if(a.clock)a=a.clock;if(b.clock)b=b.clock;return allKeys(a,b).every(function(key){if(typeof a[key]=="undefined"||typeof b[key]=="undefined")return false;var diff=a[key]-b[key];if(diff!=0)return false;return true})};exports.merge=function(a,b){var last=null,result={},wantContainer=false;if(a.clock&&b.clock)wantContainer=true;if(a.clock)a=a.clock;if(b.clock)b=b.clock;allKeys(a,b).forEach(function(key){result[key]=Math.max(a[key]||0,b[key]||0)});if(wantContainer){return{clock:result}}return result};exports.GT=1;exports.LT=-1;exports.CONCURRENT=0},{}],56:[function(require,module,exports){"use strict";var url=require("url");var reTrailingSlash=/\/$/;module.exports=function(signalhost,callback){var script;var baseUrl;var basePath;var scriptSrc;if(typeof signalhost=="function"){callback=signalhost;signalhost=location.origin}baseUrl=signalhost.replace(reTrailingSlash,"");basePath=url.parse(signalhost).pathname;scriptSrc=baseUrl+"/rtc.io/primus.js";script=document.querySelector('script[src="'+scriptSrc+'"]');if(script&&typeof Primus!="undefined"){return callback(null,Primus)}script=document.createElement("script");script.src=scriptSrc;script.onerror=callback;script.onload=function(){if(basePath!=="/"){Primus.prototype.pathname=basePath.replace(reTrailingSlash,"")+Primus.prototype.pathname}callback(null,Primus)};document.body.appendChild(script)}},{url:5}],57:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller-processor");var jsonparse=require("cog/jsonparse");var vc=require("vectorclock");module.exports=function(signaller){var id=signaller.id;var handlers=require("./handlers")(signaller);function sendEvent(parts,srcState,data){var evtName=parts[0].slice(1);var args=parts.slice(1).map(jsonparse).concat(data);signaller.emit.apply(signaller,[evtName,srcState].concat(args))}return function(originalData){var data=originalData;var isMatch=true;var parts;var handler;var srcData;var srcState;debug("signaller "+signaller.id+" received data: "+originalData);if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){parts=data.slice(5+id.length).split("|").map(jsonparse);srcData=parts[0];srcState=signaller.peers.get(srcData&&srcData.id);parts=parts.slice(1).map(jsonparse)}}if(!isMatch){return}parts=parts||data.split("|").map(jsonparse);if(parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];if(typeof handler=="function"){handler(parts.slice(1),parts[0].slice(1),srcData&&srcData.clock,srcState)}else{sendEvent(parts,srcState,originalData)}}if(srcData&&srcData.clock&&srcState){srcState.clock=vc.merge(srcState.clock,srcData.clock)}}}},{"./handlers":27,"cog/jsonparse":33,"cog/logger":34,vectorclock:55}],58:[function(require,module,exports){"use strict";var debug=require("cog/logger")("couple");var async=require("async");var monitor=require("./monitor");var detect=require("./detect");function couple(conn,targetId,signaller,opts){var mon=monitor(conn);var blockId;var stages={};var localCandidates=[];var queuedCandidates=[];var sdpFilter=(opts||{}).sdpfilter;var maxAttempts=(opts||{}).maxAttempts||1;var attemptDelay=(opts||{}).attemptDelay||3e3;var attempt=1;var attemptTimer;var offerTimeout;var createOffer=negotiate("createOffer");var createAnswer=negotiate("createAnswer");var q=async.queue(function(task,cb){if(typeof task.op!="function"){return cb()}task.op(task,cb)},1);var RTCSessionDescription=(opts||{}).RTCSessionDescription||detect("RTCSessionDescription");var RTCIceCandidate=(opts||{}).RTCIceCandidate||detect("RTCIceCandidate");function abort(stage,sdp,cb){var stageHandler=stages[stage];return function(err){debug("captured error: ",err);q.push({op:lockRelease});if(stageHandler&&attempt<maxAttempts&&!attemptTimer){attemptTimer=setTimeout(function(){attempt+=1;attemptTimer=0;debug("reattempting connection (attempt: "+attempt+")");stageHandler()},attemptDelay)}if(typeof cb=="function"){cb(err)}}}function negotiate(methodName){var hsDebug=require("cog/logger")("handshake-"+methodName);return function(task,cb){debug("calling "+methodName);conn[methodName](function(desc){if(typeof sdpFilter=="function"){desc.sdp=sdpFilter(desc.sdp,conn,methodName)}conn.setLocalDescription(desc,function(){signaller.to(targetId).send("/sdp",desc);cb()},abort(methodName,desc.sdp,cb))},abort(methodName,"",cb))}}function handleLocalCandidate(evt){if(evt.candidate){localCandidates.push(evt.candidate)}if(conn.iceGatheringState==="complete"){debug("ice gathering state complete, sending candidates");signaller.to(targetId).send("/candidates",localCandidates.splice(0))}}function handleRemoteCandidate(targetId,data){if(!conn.remoteDescription){return queuedCandidates.push(data)}try{conn.addIceCandidate(new RTCIceCandidate(data))}catch(e){debug("invalidate candidate specified: ",data)}}function handleRemoteCandidateArray(src,data){if(!src||src.id!==targetId){return}data.forEach(function(candidate){handleRemoteCandidate(targetId,candidate)})}function handleSdp(src,data){if(!src||src.id!==targetId){return}q.push({op:function(task,cb){conn.setRemoteDescription(new RTCSessionDescription(data),function(){queuedCandidates.splice(0).forEach(function(data){debug("applying queued candidate");conn.addIceCandidate(new RTCIceCandidate(data))});if(data.type==="offer"){queue(createAnswer)()}cb()},abort(data.type==="offer"?"createAnswer":"createOffer",data.sdp,cb))}})}function lockAcquire(task,cb){debug("attempting to acquire negotiate lock with target: "+targetId);signaller.lock(targetId,{label:"negotiate"},function(err){if(err){debug("error getting lock, resetting queue");queueReset()}cb(err)})}function lockRelease(task,cb){signaller.unlock(targetId,{label:"negotiate"},cb)}function queue(negotiateTask){return function(){q.push([{op:lockAcquire},{op:negotiateTask},{op:lockRelease}])}}function queueReset(){q.tasks.splice(0)}if(typeof targetId!="string"&&!(targetId instanceof String)){throw new Error("2nd argument (targetId) should be a string")}conn.addEventListener("negotiationneeded",function(){debug("renegotiation required, will create offer in 50ms");clearTimeout(offerTimeout);offerTimeout=setTimeout(queue(createOffer),50)});conn.addEventListener("icecandidate",handleLocalCandidate);signaller.on("sdp",handleSdp);signaller.on("candidate",handleRemoteCandidate);signaller.on("candidates",handleRemoteCandidateArray);mon.once("closed",function(){debug("closed");signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleRemoteCandidate)});mon.createOffer=queue(createOffer);return mon}module.exports=couple},{"./detect":59,"./monitor":62,async:14,"cog/logger":64}],59:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":23}],60:[function(require,module,exports){"use strict";var debug=require("cog/logger")("generators");var detect=require("./detect");var defaults=require("cog/defaults");var mappings={create:{data:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({RtpDataChannels:true})}},dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};var knownFlags=["video","audio","data"];exports.config=function(config){return defaults(config,{iceServers:[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;var out;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});out=defaults({},constraints,generated);debug("generated connection constraints: ",out);return out};var parseFlags=exports.parseFlags=function(options){var opts=options||{};opts.video=opts.video||typeof opts.video=="undefined";opts.audio=opts.audio||typeof opts.audio=="undefined";return Object.keys(opts||{}).filter(function(flag){return opts[flag]}).map(function(flag){return flag.toLowerCase()}).filter(function(flag){return knownFlags.indexOf(flag)>=0})}},{"./detect":59,"cog/defaults":63,"cog/logger":64}],61:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");exports.couple=require("./couple");exports.createConnection=function(opts,constraints){return new RTCPeerConnection(gen.config(opts),gen.connectionConstraints(opts,constraints))}},{"./couple":58,"./detect":59,"./generators":60,"cog/logger":64}],62:[function(require,module,exports){var process=require("__browserify_process");"use strict";var debug=require("cog/logger")("monitor");var EventEmitter=require("events").EventEmitter;var W3C_STATES={NEW:"new",LOCAL_OFFER:"have-local-offer",LOCAL_PRANSWER:"have-local-pranswer",REMOTE_PRANSWER:"have-remote-pranswer",ACTIVE:"active",CLOSED:"closed"};var monitor=module.exports=function(pc,tag){var mon=new EventEmitter;var currentState=getState(pc);var isActive=mon.active=currentState===W3C_STATES.ACTIVE;function checkState(){var newState=getState(pc,tag);debug("captured state change, new state: "+newState+", current state: "+currentState);mon.active=newState===W3C_STATES.ACTIVE;if(newState!==currentState){mon.emit(currentState=newState)}}if(isActive){process.nextTick(mon.emit.bind(mon,W3C_STATES.ACTIVE,pc))}pc.addEventListener("signalingstatechange",checkState);pc.addEventListener("iceconnectionstatechange",checkState);mon.stop=function(){pc.removeEventListener("signalingstatechange",checkState);pc.removeEventListener("iceconnectionstatechange",checkState)};return mon};var getState=monitor.getState=function(pc,tag){var signalingState=pc&&pc.signalingState;var iceGatheringState=pc&&pc.iceGatheringState;var iceConnectionState=pc&&pc.iceConnectionState;var localDesc;var remoteDesc;var state;var isActive;if(!pc){return W3C_STATES.CLOSED}tag=tag||"";localDesc=pc.localDescription;remoteDesc=pc.remoteDescription;state=signalingState;if(state==="stable"){state=W3C_STATES.NEW;if(localDesc&&remoteDesc){state=W3C_STATES.REMOTE_PRANSWER}}isActive=state===W3C_STATES.REMOTE_PRANSWER&&iceConnectionState==="connected";debug(tag+"signaling state: "+signalingState+", iceGatheringState: "+iceGatheringState+", iceConnectionState: "+iceConnectionState);return isActive?W3C_STATES.ACTIVE:state};monitor.isActive=function(pc){var isStable=pc&&pc.signalingState==="stable";return isStable&&getState(pc)===W3C_STATES.ACTIVE}},{__browserify_process:11,"cog/logger":64,events:3}],63:[function(require,module,exports){module.exports=require(15)},{}],64:[function(require,module,exports){module.exports=require(17)},{}],65:[function(require,module,exports){var parser=require("./lib/parser");var writer=require("./lib/writer");exports.write=writer;exports.parse=parser.parse;exports.parseFmtpConfig=parser.parseFmtpConfig;exports.parsePayloads=parser.parsePayloads;exports.parseRemoteCandidates=parser.parseRemoteCandidates},{"./lib/parser":67,"./lib/writer":68}],66:[function(require,module,exports){var grammar=module.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (.*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (.*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS)\:(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w\/]*)\s?(.*)?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap\:(\d*) (\w*)\/(\d*)/,names:["payload","codec","rate"],format:"rtpmap:%d %s/%d"},{push:"fmtp",reg:/^fmtp\:(\d*) (.*)/,names:["payload","config"],format:"fmtp:%d %s"},{push:"rtcpFbTrrInt",reg:/^rtcp-fb\:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb\:(\*|\d*) (\w*) ?(\w*)/,names:["payload","type","subtype"],format:"rtcp-fb:%s %s %s"},{push:"ext",reg:/^extmap:([a-zA-Z0-9_\/]*) ([^ ]*) ?(.*)/,names:["value","uri","config"],format:"extmap:%s %s %s"},{push:"crypto",reg:/^crypto:(\d*) ([a-zA-Z0-9_]*) ?([^ ]*) ?(.*)/,names:["id","suite","config","sessionConfig"],format:"crypto:%d %s %s %s"},{name:"setup",reg:/^setup\:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid\:(\w*)/,format:"mid:%s"},{name:"ptime",reg:/^ptime\:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime\:(\d*)/,format:"maxptime:%d"},{name:"sendrecv",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"iceUfrag",reg:/^ice-ufrag\:(.*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd\:(.*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint\:(\S*) (.*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)/,names:["foundation","component","transport","priority","ip","port","type"],format:"candidate:%s %d %s %d %s %d typ %s"},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options\:(.*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc\:(\d*) ([a-zA-Z0-9_]*)\:(.*)/,names:["id","attribute","value"],format:"ssrc:%d %s:%s"},{name:"msidSemantic",reg:/^msid-semantic\: (\w*) (.*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group\:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/}]};Object.keys(grammar).forEach(function(key){var objs=grammar[key];objs.forEach(function(obj){if(!obj.reg){obj.reg=/(.*)/}if(!obj.format){obj.format="%s"}})})},{}],67:[function(require,module,exports){var toIntIfInt=function(v){return String(Number(v))===v?Number(v):v};var attachProperties=function(match,location,names,rawName){if(rawName&&!names){location[rawName]=toIntIfInt(match[1])}else{for(var i=0;i<names.length;i+=1){location[names[i]]=toIntIfInt(match[i+1])}}};var parseReg=function(obj,location,content){var needsBlank=obj.name&&obj.names;if(obj.push&&!location[obj.push]){location[obj.push]=[]}else if(needsBlank&&!location[obj.name]){location[obj.name]={}}var keyLocation=obj.push?{}:needsBlank?location[obj.name]:location;attachProperties(content.match(obj.reg),keyLocation,obj.names,obj.name);if(obj.push){location[obj.push].push(keyLocation)}};var grammar=require("./grammar");var validLine=RegExp.prototype.test.bind(/^([a-z])=(.*)/);exports.parse=function(sdp){var session={},media=[],location=session;sdp.split("\n").filter(validLine).forEach(function(l){var type=l[0];var content=l.slice(2);if(type==="m"){media.push({rtp:[],fmtp:[]});location=media[media.length-1]}for(var j=0;j<(grammar[type]||[]).length;j+=1){var obj=grammar[type][j];if(obj.reg.test(content)){return parseReg(obj,location,content)}}});session.media=media;return session};var fmtpReducer=function(acc,expr){var s=expr.split("=");if(s.length===2){acc[s[0]]=toIntIfInt(s[1])}return acc};exports.parseFmtpConfig=function(str){return str.split(";").reduce(fmtpReducer,{})};exports.parsePayloads=function(str){return str.split(" ").map(Number)};exports.parseRemoteCandidates=function(str){var candidates=[];var parts=str.split(" ").map(toIntIfInt);for(var i=0;i<parts.length;i+=3){candidates.push({component:parts[i],ip:parts[i+1],port:parts[i+2]})}return candidates}},{"./grammar":66}],68:[function(require,module,exports){var grammar=require("./grammar");var format=require("util").format;var makeLine=function(type,obj,location){var args=[type+"="+obj.format];if(obj.names){for(var i=0;i<obj.names.length;i+=1){var n=obj.names[i];if(obj.name){args.push(location[obj.name][n])}else{args.push(location[obj.names[i]])}}}else{args.push(location[obj.name])}return format.apply(null,args)};var defaultOuterOrder=["v","o","s","i","u","e","p","c","b","z","a","t","r"];var defaultInnerOrder=["i","c","b","a"];module.exports=function(session,opts){opts=opts||{};if(session.version==null){session.version=0}if(session.name==null){session.name=" "}session.media.forEach(function(mLine){if(mLine.payloads==null){mLine.payloads=""}});var outerOrder=opts.outerOrder||defaultOuterOrder;var innerOrder=opts.innerOrder||defaultInnerOrder;var sdp=[];outerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in session){sdp.push(makeLine(type,obj,session))}else if(obj.push in session){session[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})});session.media.forEach(function(mLine){sdp.push(makeLine("m",grammar.m[0],mLine));innerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in mLine){sdp.push(makeLine(type,obj,mLine))}else if(obj.push in mLine){mLine[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})})});return sdp.join("\n")+"\n"}},{"./grammar":66,util:6}],69:[function(require,module,exports){"use strict";var eve=require("eve");var EventEmitter=require("events").EventEmitter;var rtc=require("rtc");var debug=require("cog/logger")("glue-sessionmanager");var createSignaller=require("rtc-signaller");var extend=require("cog/extend");var util=require("util");function SessionManager(config){if(!(this instanceof SessionManager)){return new SessionManager(config)}EventEmitter.call(this);this.room=config.room;this.role=config.role;this.cfg=config;this.peers={};this.streams={};this.socket=new Primus(config.signalhost);this.socket.on("open",this.emit.bind(this,"active"));this.signaller=createSignaller(this.socket);this._bindEvents(this.signaller,config)}module.exports=SessionManager;util.inherits(SessionManager,EventEmitter);SessionManager.prototype.announce=function(targetId){var scope=targetId?this.signaller.to(targetId):this.signaller;debug("announcing self to: "+(targetId||"all"));scope.announce({room:this.room,role:this.role})};SessionManager.prototype.broadcast=function(stream,data){var peers=this.peers;var mgr=this;function connectPeer(peer,peerId){mgr.tagStream(stream,peerId,data);try{peer.addStream(stream)}catch(e){debug("captured error attempting to add stream: ",e)}}debug("broadcasting stream "+stream.id+" to existing peers");Object.keys(peers).forEach(function(peerId){if(peers[peerId]){debug("broadcasting to peer: "+peerId);connectPeer(peers[peerId],peerId)}});eve.on("glue.peer.join",function(peer,peerId){debug("peer "+peerId+" joined, connecting to stream: "+stream.id);connectPeer(peer,peerId)});stream.onended=function(){eve.off("glue.peer.join",connectPeer)}};SessionManager.prototype.getStreamData=function(stream,callback){var id=stream&&stream.id;var data=this.streams[id];if(!id){return}if(data){callback(data)}else{eve.once("glue.streamdata."+id,callback)}};SessionManager.prototype.tagStream=function(stream,targetId,data){this.signaller.to(targetId).send("/streamdata",extend({},data,{id:stream.id,label:stream.label}))};SessionManager.prototype._bindEvents=function(signaller,opts){var mgr=this;debug("initializing event handlers");signaller.on("peer:announce",function(data){var ns="glue.peer.join."+(data.role||"none");var peer;var monitor;debug("captured announce event for peer: "+data.id);if(data.room!==mgr.room){return debug("received announce for incorrect room")}if(mgr.peers[data.id]){return debug("known peer")}peer=mgr.peers[data.id]=rtc.createConnection(opts,opts.constraints);monitor=rtc.couple(peer,data.id,signaller,opts);monitor.once("active",function(){eve("glue.peer.active."+(data.role||"none"),null,peer,data.id)});eve("glue.peer.join."+(data.role||"none"),null,peer,data.id)});signaller.on("peer:leave",function(id){console.log(arguments);var peer=mgr.peers[id];debug("captured leave event for peer: "+id);if(peer){peer.close();mgr.peers[id]=undefined;eve("glue.peer.leave",null,peer,id)}});signaller.on("streamdata",function(src,data){mgr.streams[data.id]=data;eve("glue.streamdata."+data.id,null,data)})}},{"cog/extend":16,"cog/logger":17,eve:18,events:3,rtc:61,"rtc-signaller":31,util:6}]},{},[13])(13)});